<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Segmentation Module Documentation | Copper3d API</title>
    <meta name="description" content="A VitePress site">
    <link rel="preload stylesheet" href="/copper3d_visualisation/assets/style.fecbcd0a.css" as="style">
    
    <script type="module" src="/copper3d_visualisation/assets/app.5ec4ab65.js"></script>
    <link rel="preload" href="/copper3d_visualisation/assets/inter-roman-latin.2ed14f66.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/copper3d_visualisation/assets/chunks/framework.5916b37e.js">
    <link rel="modulepreload" href="/copper3d_visualisation/assets/chunks/theme.6b888f25.js">
    <link rel="modulepreload" href="/copper3d_visualisation/assets/guide_segmentation-module.md.16e1da9b.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-9d8abc1e><!--[--><!--]--><!--[--><span tabindex="-1" data-v-c8291ffa></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-c8291ffa> Skip to content </a><!--]--><!----><header class="VPNav" data-v-9d8abc1e data-v-7ad780c2><div class="VPNavBar has-sidebar" data-v-7ad780c2 data-v-f1abbc6e><div class="container" data-v-f1abbc6e><div class="title" data-v-f1abbc6e><div class="VPNavBarTitle has-sidebar" data-v-f1abbc6e data-v-2973dbb4><a class="title" href="/copper3d_visualisation/" data-v-2973dbb4><!--[--><!--]--><!----><!--[-->Copper3d API<!--]--><!--[--><!--]--></a></div></div><div class="content" data-v-f1abbc6e><div class="curtain" data-v-f1abbc6e></div><div class="content-body" data-v-f1abbc6e><!--[--><!--]--><div class="VPNavBarSearch search" data-v-f1abbc6e><!--[--><!----><div id="docsearch"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg class="DocSearch-Search-Icon" width="20" height="20" viewBox="0 0 20 20" aria-label="search icon"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-f1abbc6e data-v-f732b5d0><span id="main-nav-aria-label" class="visually-hidden" data-v-f732b5d0>Main Navigation</span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/copper3d_visualisation/guide/nrrd-tools.html" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>Guide</span><!--]--></a><!--]--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/copper3d_visualisation/apidist/modules.html" tabindex="0" data-v-f732b5d0 data-v-cb318fec><!--[--><span data-v-cb318fec>API</span><!--]--></a><!--]--><!--]--></nav><div class="VPFlyout VPNavBarTranslations translations" data-v-f1abbc6e data-v-ff4524ae data-v-aa8de344><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="Change language" data-v-aa8de344><span class="text" data-v-aa8de344><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="option-icon" data-v-aa8de344><path d="M0 0h24v24H0z" fill="none"></path><path d=" M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z " class="css-c4d79v"></path></svg><!----><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="text-icon" data-v-aa8de344><path d="M12,16c-0.3,0-0.5-0.1-0.7-0.3l-6-6c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l5.3,5.3l5.3-5.3c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-6,6C12.5,15.9,12.3,16,12,16z"></path></svg></span></button><div class="menu" data-v-aa8de344><div class="VPMenu" data-v-aa8de344 data-v-e42ed9b3><!----><!--[--><!--[--><div class="items" data-v-ff4524ae><p class="title" data-v-ff4524ae>English</p><!--[--><div class="VPMenuLink" data-v-ff4524ae data-v-f51f088d><a class="VPLink link" href="/copper3d_visualisation/zh/guide/segmentation-module.html" data-v-f51f088d><!--[-->简体中文<!--]--></a></div><!--]--></div><!--]--><!--]--></div></div></div><div class="VPNavBarAppearance appearance" data-v-f1abbc6e data-v-283b26e9><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-283b26e9 data-v-3329432d data-v-1c29e291><span class="check" data-v-1c29e291><span class="icon" data-v-1c29e291><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-3329432d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-3329432d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div><!----><div class="VPFlyout VPNavBarExtra extra" data-v-f1abbc6e data-v-c8c2ae4b data-v-aa8de344><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-aa8de344><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="icon" data-v-aa8de344><circle cx="12" cy="12" r="2"></circle><circle cx="19" cy="12" r="2"></circle><circle cx="5" cy="12" r="2"></circle></svg></button><div class="menu" data-v-aa8de344><div class="VPMenu" data-v-aa8de344 data-v-e42ed9b3><!----><!--[--><!--[--><div class="group translations" data-v-c8c2ae4b><p class="trans-title" data-v-c8c2ae4b>English</p><!--[--><div class="VPMenuLink" data-v-c8c2ae4b data-v-f51f088d><a class="VPLink link" href="/copper3d_visualisation/zh/guide/segmentation-module.html" data-v-f51f088d><!--[-->简体中文<!--]--></a></div><!--]--></div><div class="group" data-v-c8c2ae4b><div class="item appearance" data-v-c8c2ae4b><p class="label" data-v-c8c2ae4b>Appearance</p><div class="appearance-action" data-v-c8c2ae4b><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title="toggle dark mode" aria-checked="false" data-v-c8c2ae4b data-v-3329432d data-v-1c29e291><span class="check" data-v-1c29e291><span class="icon" data-v-1c29e291><!--[--><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="sun" data-v-3329432d><path d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4c0,2.2,1.8,4,4,4c2.2,0,4-1.8,4-4C16,9.8,14.2,8,12,8z"></path><path d="M12,4c-0.6,0-1-0.4-1-1V1c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,3.6,12.6,4,12,4z"></path><path d="M12,24c-0.6,0-1-0.4-1-1v-2c0-0.6,0.4-1,1-1s1,0.4,1,1v2C13,23.6,12.6,24,12,24z"></path><path d="M5.6,6.6c-0.3,0-0.5-0.1-0.7-0.3L3.5,4.9c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C6.2,6.5,5.9,6.6,5.6,6.6z"></path><path d="M19.8,20.8c-0.3,0-0.5-0.1-0.7-0.3l-1.4-1.4c-0.4-0.4-0.4-1,0-1.4s1-0.4,1.4,0l1.4,1.4c0.4,0.4,0.4,1,0,1.4C20.3,20.7,20,20.8,19.8,20.8z"></path><path d="M3,13H1c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S3.6,13,3,13z"></path><path d="M23,13h-2c-0.6,0-1-0.4-1-1s0.4-1,1-1h2c0.6,0,1,0.4,1,1S23.6,13,23,13z"></path><path d="M4.2,20.8c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C4.7,20.7,4.5,20.8,4.2,20.8z"></path><path d="M18.4,6.6c-0.3,0-0.5-0.1-0.7-0.3c-0.4-0.4-0.4-1,0-1.4l1.4-1.4c0.4-0.4,1-0.4,1.4,0s0.4,1,0,1.4l-1.4,1.4C18.9,6.5,18.6,6.6,18.4,6.6z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="moon" data-v-3329432d><path d="M12.1,22c-0.3,0-0.6,0-0.9,0c-5.5-0.5-9.5-5.4-9-10.9c0.4-4.8,4.2-8.6,9-9c0.4,0,0.8,0.2,1,0.5c0.2,0.3,0.2,0.8-0.1,1.1c-2,2.7-1.4,6.4,1.3,8.4c2.1,1.6,5,1.6,7.1,0c0.3-0.2,0.7-0.3,1.1-0.1c0.3,0.2,0.5,0.6,0.5,1c-0.2,2.7-1.5,5.1-3.6,6.8C16.6,21.2,14.4,22,12.1,22zM9.3,4.4c-2.9,1-5,3.6-5.2,6.8c-0.4,4.4,2.8,8.3,7.2,8.7c2.1,0.2,4.2-0.4,5.8-1.8c1.1-0.9,1.9-2.1,2.4-3.4c-2.5,0.9-5.3,0.5-7.5-1.1C9.2,11.4,8.1,7.7,9.3,4.4z"></path></svg><!--]--></span></span></button></div></div></div><!----><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-f1abbc6e data-v-6bee1efd><span class="container" data-v-6bee1efd><span class="top" data-v-6bee1efd></span><span class="middle" data-v-6bee1efd></span><span class="bottom" data-v-6bee1efd></span></span></button></div></div></div></div><!----></header><div class="VPLocalNav reached-top" data-v-9d8abc1e data-v-9e669cc1><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-9e669cc1><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" viewbox="0 0 24 24" class="menu-icon" data-v-9e669cc1><path d="M17,11H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,11,17,11z"></path><path d="M21,7H3C2.4,7,2,6.6,2,6s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,7,21,7z"></path><path d="M21,15H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h18c0.6,0,1,0.4,1,1S21.6,15,21,15z"></path><path d="M17,19H3c-0.6,0-1-0.4-1-1s0.4-1,1-1h14c0.6,0,1,0.4,1,1S17.6,19,17,19z"></path></svg><span class="menu-text" data-v-9e669cc1>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-9e669cc1 data-v-24251f6f><button data-v-24251f6f>Return to top</button><!----></div></div><aside class="VPSidebar" data-v-9d8abc1e data-v-ee2efba5><div class="curtain" data-v-ee2efba5></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-ee2efba5><span class="visually-hidden" id="sidebar-aria-label" data-v-ee2efba5> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="group" data-v-ee2efba5><section class="VPSidebarItem level-0" data-v-ee2efba5 data-v-bd01e0d5><div class="item" role="button" tabindex="0" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><h2 class="text" data-v-bd01e0d5>Usage Guide</h2><!----></div><div class="items" data-v-bd01e0d5><!--[--><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/copper3d_visualisation/guide/nrrd-tools.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>NrrdTools Usage Guide</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="group" data-v-ee2efba5><section class="VPSidebarItem level-0 has-active" data-v-ee2efba5 data-v-bd01e0d5><div class="item" role="button" tabindex="0" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><h2 class="text" data-v-bd01e0d5>Architecture</h2><!----></div><div class="items" data-v-bd01e0d5><!--[--><div class="VPSidebarItem level-1 is-link" data-v-bd01e0d5 data-v-bd01e0d5><div class="item" data-v-bd01e0d5><div class="indicator" data-v-bd01e0d5></div><a class="VPLink link link" href="/copper3d_visualisation/guide/segmentation-module.html" data-v-bd01e0d5><!--[--><p class="text" data-v-bd01e0d5>Segmentation Module</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-9d8abc1e data-v-3cf691b6><div class="VPDoc has-sidebar has-aside" data-v-3cf691b6 data-v-a3c25e27><!--[--><!--]--><div class="container" data-v-a3c25e27><div class="aside" data-v-a3c25e27><div class="aside-curtain" data-v-a3c25e27></div><div class="aside-container" data-v-a3c25e27><div class="aside-content" data-v-a3c25e27><div class="VPDocAside" data-v-a3c25e27 data-v-cb998dce><!--[--><!--]--><!--[--><!--]--><div class="VPDocAsideOutline" role="navigation" data-v-cb998dce data-v-3a6c4994><div class="content" data-v-3a6c4994><div class="outline-marker" data-v-3a6c4994></div><div class="outline-title" role="heading" aria-level="2" data-v-3a6c4994>On this page</div><nav aria-labelledby="doc-outline-aria-label" data-v-3a6c4994><span class="visually-hidden" id="doc-outline-aria-label" data-v-3a6c4994> Table of Contents for current page </span><ul class="root" data-v-3a6c4994 data-v-463da30f><!--[--><!--]--></ul></nav></div></div><!--[--><!--]--><div class="spacer" data-v-cb998dce></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-a3c25e27><div class="content-container" data-v-a3c25e27><!--[--><!--]--><!----><main class="main" data-v-a3c25e27><div style="position:relative;" class="vp-doc _copper3d_visualisation_guide_segmentation-module" data-v-a3c25e27><div><h1 id="segmentation-module-documentation" tabindex="-1">Segmentation Module Documentation <a class="header-anchor" href="#segmentation-module-documentation" aria-label="Permalink to &quot;Segmentation Module Documentation&quot;">​</a></h1><blockquote><p>Source: <code>src/Utils/segmentation/</code></p></blockquote><blockquote><p>⚠️ <strong>Note</strong>: All line number references in this document are from historical versions. After multiple rounds of refactoring (State Management Refactor, NrrdTools God Class Split, inheritance → composition refactor), these references are outdated and provided for structural reference only. Always refer to the actual source code.</p></blockquote><h2 id="_1-architecture-overview" tabindex="-1">1. Architecture Overview <a class="header-anchor" href="#_1-architecture-overview" aria-label="Permalink to &quot;1. Architecture Overview&quot;">​</a></h2><h3 id="_1-1-class-composition" tabindex="-1">1.1 Class Composition <a class="header-anchor" href="#_1-1-class-composition" aria-label="Permalink to &quot;1.1 Class Composition&quot;">​</a></h3><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">NrrdTools (Facade)</span></span>
<span class="line"><span style="color:#e1e4e8;">  ├── CanvasState              ← Pure state container (nrrd_states, gui_states, protectedData, etc.)</span></span>
<span class="line"><span style="color:#e1e4e8;">  ├── DrawToolCore             ← Event orchestration, Undo/Redo, Tool initialization and delegation</span></span>
<span class="line"><span style="color:#e1e4e8;">  │     ├── CanvasState (shared)  ← References the same CanvasState instance</span></span>
<span class="line"><span style="color:#e1e4e8;">  │     └── RenderingUtils     ← Rendering / slice-buffer helpers</span></span>
<span class="line"><span style="color:#e1e4e8;">  ├── LayerChannelManager      ← Layer/Channel/SphereType management (211 lines)</span></span>
<span class="line"><span style="color:#e1e4e8;">  ├── SliceRenderPipeline      ← Slice rendering pipeline (453 lines)</span></span>
<span class="line"><span style="color:#e1e4e8;">  └── DataLoader               ← Data loading (222 lines)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">NrrdTools (Facade)</span></span>
<span class="line"><span style="color:#24292e;">  ├── CanvasState              ← Pure state container (nrrd_states, gui_states, protectedData, etc.)</span></span>
<span class="line"><span style="color:#24292e;">  ├── DrawToolCore             ← Event orchestration, Undo/Redo, Tool initialization and delegation</span></span>
<span class="line"><span style="color:#24292e;">  │     ├── CanvasState (shared)  ← References the same CanvasState instance</span></span>
<span class="line"><span style="color:#24292e;">  │     └── RenderingUtils     ← Rendering / slice-buffer helpers</span></span>
<span class="line"><span style="color:#24292e;">  ├── LayerChannelManager      ← Layer/Channel/SphereType management (211 lines)</span></span>
<span class="line"><span style="color:#24292e;">  ├── SliceRenderPipeline      ← Slice rendering pipeline (453 lines)</span></span>
<span class="line"><span style="color:#24292e;">  └── DataLoader               ← Data loading (222 lines)</span></span></code></pre></div><blockquote><p><strong>Inheritance → Composition Refactor (complete)</strong>: The original three-level inheritance chain <code>NrrdTools → DrawToolCore → CommToolsData</code> has been fully replaced by composition. <code>CommToolsData</code> has been deleted. State is extracted into <code>CanvasState</code>, rendering methods into <code>RenderingUtils</code>.</p><p><strong>DrawToolCore</strong> is now a pure orchestration layer — all tool logic has been extracted into individual Tool classes. DrawToolCore permanently routes all pointer/wheel events via EventRouter, and dispatches each Tool&#39;s render methods in the <code>start()</code> render loop. There are no more manual <code>addEventListener</code>/<code>removeEventListener</code> calls (wheel behavior is dispatched via <code>activeWheelMode</code> state).</p><p><strong>NrrdTools God Class Split (complete)</strong>: NrrdTools was refactored across 4 phases from a 2007-line God Class into a Facade + 3 functional modules. The public API is unchanged; internals are decoupled via <code>ToolContext</code> + <code>ToolHost</code> <code>Pick&lt;&gt;</code> types.</p><p><strong>Callback interface unification (complete)</strong>: The original 10 separate <code>*Callbacks</code> interfaces have been unified into a single <code>ToolHost</code> interface (<code>tools/ToolHost.ts</code>). Each Tool selects its required host method subset via <code>Pick&lt;ToolHost, ...&gt;</code>.</p></blockquote><ul><li><a href="../../src/Utils/segmentation/CanvasState.ts">CanvasState.ts</a> — Pure state container</li><li><a href="../../src/Utils/segmentation/RenderingUtils.ts">RenderingUtils.ts</a> — Rendering utilities</li><li><a href="../../src/Utils/segmentation/DrawToolCore.ts">DrawToolCore.ts</a> — Drawing core (composes CanvasState + RenderingUtils)</li><li><a href="../../src/Utils/segmentation/NrrdTools.ts">NrrdTools.ts</a> — Public API Facade (composes CanvasState + DrawToolCore)</li><li><a href="../../src/Utils/segmentation/tools/LayerChannelManager.ts">tools/LayerChannelManager.ts</a> — Layer/Channel management</li><li><a href="../../src/Utils/segmentation/tools/SliceRenderPipeline.ts">tools/SliceRenderPipeline.ts</a> — Slice rendering pipeline</li><li><a href="../../src/Utils/segmentation/tools/DataLoader.ts">tools/DataLoader.ts</a> — Data loading</li></ul><h3 id="_1-2-canvas-layer-structure" tabindex="-1">1.2 Canvas Layer Structure <a class="header-anchor" href="#_1-2-canvas-layer-structure" aria-label="Permalink to &quot;1.2 Canvas Layer Structure&quot;">​</a></h3><p>There are <strong>5 system canvases</strong> + <strong>N layer canvases</strong> (3 layers by default).</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">┌──────────────────────────────────┐</span></span>
<span class="line"><span style="color:#e1e4e8;">│ drawingCanvas (top interaction)   │  ← Captures mouse/pen events, real-time stroke rendering</span></span>
<span class="line"><span style="color:#e1e4e8;">├──────────────────────────────────┤</span></span>
<span class="line"><span style="color:#e1e4e8;">│ drawingSphereCanvas              │  ← Overlay for the 3D Sphere tool</span></span>
<span class="line"><span style="color:#e1e4e8;">├──────────────────────────────────┤</span></span>
<span class="line"><span style="color:#e1e4e8;">│ drawingCanvasLayerMaster (composite) │  ← Result of compositing all visible layers</span></span>
<span class="line"><span style="color:#e1e4e8;">│   ├─ layerTargets[layer1].canvas │  ← Hidden per-layer canvas</span></span>
<span class="line"><span style="color:#e1e4e8;">│   ├─ layerTargets[layer2].canvas │</span></span>
<span class="line"><span style="color:#e1e4e8;">│   └─ layerTargets[layer3].canvas │</span></span>
<span class="line"><span style="color:#e1e4e8;">├──────────────────────────────────┤</span></span>
<span class="line"><span style="color:#e1e4e8;">│ displayCanvas (background image)  │  ← CT/MRI slice image</span></span>
<span class="line"><span style="color:#e1e4e8;">├──────────────────────────────────┤</span></span>
<span class="line"><span style="color:#e1e4e8;">│ originCanvas (from Three.js)      │  ← Cached original slice rendered by Three.js</span></span>
<span class="line"><span style="color:#e1e4e8;">├──────────────────────────────────┤</span></span>
<span class="line"><span style="color:#e1e4e8;">│ emptyCanvas (temporary)           │  ← Off-screen canvas for image processing and format conversion</span></span>
<span class="line"><span style="color:#e1e4e8;">└──────────────────────────────────┘</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">┌──────────────────────────────────┐</span></span>
<span class="line"><span style="color:#24292e;">│ drawingCanvas (top interaction)   │  ← Captures mouse/pen events, real-time stroke rendering</span></span>
<span class="line"><span style="color:#24292e;">├──────────────────────────────────┤</span></span>
<span class="line"><span style="color:#24292e;">│ drawingSphereCanvas              │  ← Overlay for the 3D Sphere tool</span></span>
<span class="line"><span style="color:#24292e;">├──────────────────────────────────┤</span></span>
<span class="line"><span style="color:#24292e;">│ drawingCanvasLayerMaster (composite) │  ← Result of compositing all visible layers</span></span>
<span class="line"><span style="color:#24292e;">│   ├─ layerTargets[layer1].canvas │  ← Hidden per-layer canvas</span></span>
<span class="line"><span style="color:#24292e;">│   ├─ layerTargets[layer2].canvas │</span></span>
<span class="line"><span style="color:#24292e;">│   └─ layerTargets[layer3].canvas │</span></span>
<span class="line"><span style="color:#24292e;">├──────────────────────────────────┤</span></span>
<span class="line"><span style="color:#24292e;">│ displayCanvas (background image)  │  ← CT/MRI slice image</span></span>
<span class="line"><span style="color:#24292e;">├──────────────────────────────────┤</span></span>
<span class="line"><span style="color:#24292e;">│ originCanvas (from Three.js)      │  ← Cached original slice rendered by Three.js</span></span>
<span class="line"><span style="color:#24292e;">├──────────────────────────────────┤</span></span>
<span class="line"><span style="color:#24292e;">│ emptyCanvas (temporary)           │  ← Off-screen canvas for image processing and format conversion</span></span>
<span class="line"><span style="color:#24292e;">└──────────────────────────────────┘</span></span></code></pre></div><p><strong>Canvas creation locations:</strong></p><ul><li>System canvases: <code>CanvasState.ts</code> → <code>generateSystemCanvases()</code></li><li>Layer canvases: <code>CanvasState.ts</code> → <code>generateLayerTargets(layerIds)</code></li><li>Canvas annotations: <code>CanvasState.ts</code> constructor</li></ul><h3 id="_1-3-nrrdtools-facade-internal-modules" tabindex="-1">1.3 NrrdTools Facade Internal Modules <a class="header-anchor" href="#_1-3-nrrdtools-facade-internal-modules" aria-label="Permalink to &quot;1.3 NrrdTools Facade Internal Modules&quot;">​</a></h3><p>NrrdTools passes shared state to each module via <code>ToolContext</code>, and declares host method dependencies via <code>Pick&lt;ToolHost, ...&gt;</code> type aliases:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">ToolContext = {</span></span>
<span class="line"><span style="color:#e1e4e8;">  nrrd_states: NrrdState,</span></span>
<span class="line"><span style="color:#e1e4e8;">  gui_states: GuiState,</span></span>
<span class="line"><span style="color:#e1e4e8;">  protectedData: IProtected,</span></span>
<span class="line"><span style="color:#e1e4e8;">  cursorPage: ICursorPage,</span></span>
<span class="line"><span style="color:#e1e4e8;">  callbacks: IAnnotationCallbacks,</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">ToolContext = {</span></span>
<span class="line"><span style="color:#24292e;">  nrrd_states: NrrdState,</span></span>
<span class="line"><span style="color:#24292e;">  gui_states: GuiState,</span></span>
<span class="line"><span style="color:#24292e;">  protectedData: IProtected,</span></span>
<span class="line"><span style="color:#24292e;">  cursorPage: ICursorPage,</span></span>
<span class="line"><span style="color:#24292e;">  callbacks: IAnnotationCallbacks,</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><table><thead><tr><th>Module</th><th>File</th><th>Responsibility</th><th>HostDeps Type</th></tr></thead><tbody><tr><td><strong>LayerChannelManager</strong></td><td><code>tools/LayerChannelManager.ts</code></td><td>setActiveLayer/Channel/SphereType, visibility control, custom channel colors</td><td><code>LayerChannelHostDeps</code> (3 methods)</td></tr><tr><td><strong>SliceRenderPipeline</strong></td><td><code>tools/SliceRenderPipeline.ts</code></td><td>Slice axis config, canvas rendering, mask reload, canvas flip, view/canvas helpers</td><td><code>SliceRenderHostDeps</code> (10 methods)</td></tr><tr><td><strong>DataLoader</strong></td><td><code>tools/DataLoader.ts</code></td><td>NRRD slice loading, legacy mask loading, NIfTI voxel loading</td><td><code>DataLoaderHostDeps</code> (7 methods)</td></tr></tbody></table><p>Delegation methods in NrrdTools are single-line calls (<code>this.layerChannelManager.xxx()</code>), containing no business logic.</p><h3 id="_1-4-layer-and-maskvolume-correspondence" tabindex="-1">1.4 Layer and MaskVolume Correspondence <a class="header-anchor" href="#_1-4-layer-and-maskvolume-correspondence" aria-label="Permalink to &quot;1.4 Layer and MaskVolume Correspondence&quot;">​</a></h3><p>Each Layer maps to an independent <code>MaskVolume</code> instance:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">protectedData.maskData.volumes = {</span></span>
<span class="line"><span style="color:#e1e4e8;">  &quot;layer1&quot;: MaskVolume(width, height, depth, 1),</span></span>
<span class="line"><span style="color:#e1e4e8;">  &quot;layer2&quot;: MaskVolume(width, height, depth, 1),</span></span>
<span class="line"><span style="color:#e1e4e8;">  &quot;layer3&quot;: MaskVolume(width, height, depth, 1),</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">protectedData.maskData.volumes = {</span></span>
<span class="line"><span style="color:#24292e;">  &quot;layer1&quot;: MaskVolume(width, height, depth, 1),</span></span>
<span class="line"><span style="color:#24292e;">  &quot;layer2&quot;: MaskVolume(width, height, depth, 1),</span></span>
<span class="line"><span style="color:#24292e;">  &quot;layer3&quot;: MaskVolume(width, height, depth, 1),</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre></div><ul><li>Initialized (1×1×1 placeholder): <code>CanvasState.ts</code> constructor</li><li>Re-initialized with actual NRRD dimensions: <code>DataLoader.setAllSlices()</code> → <code>tools/DataLoader.ts</code></li></ul><hr><h2 id="_2-nrrdtools-public-api" tabindex="-1">2. NrrdTools Public API <a class="header-anchor" href="#_2-nrrdtools-public-api" aria-label="Permalink to &quot;2. NrrdTools Public API&quot;">​</a></h2><blockquote><p>⚠️ <strong>Line numbers are outdated</strong>. After the God Class Split refactor (1300 lines, 13 sections), method implementations have been migrated to the extracted modules (LayerChannelManager, SliceRenderPipeline, DataLoader). NrrdTools retains only single-line delegations. Line numbers are for historical reference only — always refer to the actual source code.</p><p>Implementation locations: Layer/Channel methods → <code>tools/LayerChannelManager.ts</code>, rendering methods → <code>tools/SliceRenderPipeline.ts</code>, data loading → <code>tools/DataLoader.ts</code>.</p></blockquote><h3 id="_2-1-layer-channel-management" tabindex="-1">2.1 Layer &amp; Channel Management <a class="header-anchor" href="#_2-1-layer-channel-management" aria-label="Permalink to &quot;2.1 Layer &amp; Channel Management&quot;">​</a></h3><blockquote><p><strong>Implementation</strong>: <code>tools/LayerChannelManager.ts</code>, single-line delegation in NrrdTools.</p></blockquote><table><thead><tr><th>Method</th><th>Signature</th><th>Description</th></tr></thead><tbody><tr><td><code>setActiveLayer</code></td><td><code>(layerId: string): void</code></td><td>Set the active Layer; also updates fillColor/brushColor</td></tr><tr><td><code>setActiveChannel</code></td><td><code>(channel: ChannelValue): void</code></td><td>Set the active Channel (1–8); updates brush color</td></tr><tr><td><code>getActiveLayer</code></td><td><code>(): string</code></td><td>Get the current Layer ID</td></tr><tr><td><code>getActiveChannel</code></td><td><code>(): number</code></td><td>Get the current Channel value</td></tr><tr><td><code>setLayerVisible</code></td><td><code>(layerId, visible): void</code></td><td>Set Layer visibility, triggers <code>reloadMasksFromVolume()</code></td></tr><tr><td><code>isLayerVisible</code></td><td><code>(layerId): boolean</code></td><td>Check if a Layer is visible</td></tr><tr><td><code>setChannelVisible</code></td><td><code>(layerId, channel, visible): void</code></td><td>Set Channel visibility within a Layer, triggers re-render</td></tr><tr><td><code>isChannelVisible</code></td><td><code>(layerId, channel): boolean</code></td><td>Check if a Channel is visible</td></tr><tr><td><code>getLayerVisibility</code></td><td><code>(): Record&lt;string, boolean&gt;</code></td><td>Get a copy of all Layer visibility states</td></tr><tr><td><code>getChannelVisibility</code></td><td><code>(): Record&lt;string, Record&lt;number, boolean&gt;&gt;</code></td><td>Get a copy of all Channel visibility states</td></tr><tr><td><code>hasLayerData</code></td><td><code>(layerId): boolean</code></td><td>Check if a Layer has any non-zero data</td></tr></tbody></table><h3 id="_2-2-custom-channel-color-api" tabindex="-1">2.2 Custom Channel Color API <a class="header-anchor" href="#_2-2-custom-channel-color-api" aria-label="Permalink to &quot;2.2 Custom Channel Color API&quot;">​</a></h3><p>Per-layer custom channel colors. Each layer&#39;s MaskVolume has an independent <code>colorMap</code> — changes do not affect other layers.</p><table><thead><tr><th>Method</th><th>Signature</th><th>Description</th></tr></thead><tbody><tr><td><code>setChannelColor</code></td><td><code>(layerId: string, channel: number, color: RGBAColor): void</code></td><td>Set color for a specific channel in a layer; triggers re-render and <code>onChannelColorChanged</code> callback</td></tr><tr><td><code>getChannelColor</code></td><td><code>(layerId: string, channel: number): RGBAColor</code></td><td>Get the RGBA color object</td></tr><tr><td><code>getChannelHexColor</code></td><td><code>(layerId: string, channel: number): string</code></td><td>Get Hex string (e.g. <code>#ff8000</code>)</td></tr><tr><td><code>getChannelCssColor</code></td><td><code>(layerId: string, channel: number): string</code></td><td>Get CSS rgba() string (e.g. <code>rgba(255,128,0,1.00)</code>)</td></tr><tr><td><code>setChannelColors</code></td><td><code>(layerId: string, colorMap: Partial&lt;ChannelColorMap&gt;): void</code></td><td>Batch-set multiple channel colors for one layer (single reload)</td></tr><tr><td><code>setAllLayersChannelColor</code></td><td><code>(channel: number, color: RGBAColor): void</code></td><td>Set the same channel color across all layers</td></tr><tr><td><code>resetChannelColors</code></td><td><code>(layerId?: string, channel?: number): void</code></td><td>Reset to <code>MASK_CHANNEL_COLORS</code> defaults</td></tr></tbody></table><p><strong>Internal mechanism:</strong></p><ul><li><code>syncBrushColor()</code> — private method that dynamically reads the current layer&#39;s volume color to update <code>fillColor</code>/<code>brushColor</code></li><li>Called automatically in <code>setActiveLayer()</code>, <code>setActiveChannel()</code>, <code>setChannelColor()</code>, etc.</li></ul><h4 id="external-usage" tabindex="-1">External Usage <a class="header-anchor" href="#external-usage" aria-label="Permalink to &quot;External Usage&quot;">​</a></h4><p><strong>Prerequisite</strong>: The <code>nrrdTools</code> instance must be created and <code>setAllSlices()</code> must have been called (i.e., image is loaded and MaskVolume is initialized).</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>Colors must be set <strong>after</strong> image loading is complete (<code>setAllSlices()</code> called). If MaskVolume has not yet been created, calls will silently fail (<code>console.warn</code>).</p></div><hr><p><strong>Scenario 1: Set a custom color for a specific channel in a layer</strong></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// Set layer2&#39;s channel 3 to orange</span></span>
<span class="line"><span style="color:#E1E4E8;">nrrdTools.</span><span style="color:#B392F0;">setChannelColor</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;layer2&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">, { r: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">, g: </span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">, b: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, a: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#6A737D;">// Effect: all masks drawn with channel 3 on layer2 become orange</span></span>
<span class="line"><span style="color:#6A737D;">// layer1 and layer3&#39;s channel 3 colors are unaffected</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// Set layer2&#39;s channel 3 to orange</span></span>
<span class="line"><span style="color:#24292E;">nrrdTools.</span><span style="color:#6F42C1;">setChannelColor</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;layer2&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, { r: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">, g: </span><span style="color:#005CC5;">128</span><span style="color:#24292E;">, b: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, a: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;"> });</span></span>
<span class="line"><span style="color:#6A737D;">// Effect: all masks drawn with channel 3 on layer2 become orange</span></span>
<span class="line"><span style="color:#6A737D;">// layer1 and layer3&#39;s channel 3 colors are unaffected</span></span></code></pre></div><hr><p><strong>Scenario 2: Batch-set multiple channel colors in one layer (recommended — triggers a single re-render)</strong></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">nrrdTools.</span><span style="color:#B392F0;">setChannelColors</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;layer1&#39;</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">: { r: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">, g: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,   b: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,   a: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;"> },   </span><span style="color:#6A737D;">// channel 1 → red</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">: { r: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,   g: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,   b: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">, a: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;"> },   </span><span style="color:#6A737D;">// channel 2 → blue</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">: { r: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">, g: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">, b: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">,   a: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;"> },   </span><span style="color:#6A737D;">// channel 3 → yellow</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"><span style="color:#6A737D;">// Triggers only one reloadMasksFromVolume() — more efficient than multiple setChannelColor() calls</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">nrrdTools.</span><span style="color:#6F42C1;">setChannelColors</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;layer1&#39;</span><span style="color:#24292E;">, {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">: { r: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">, g: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">,   b: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">,   a: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;"> },   </span><span style="color:#6A737D;">// channel 1 → red</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">: { r: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">,   g: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">,   b: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">, a: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;"> },   </span><span style="color:#6A737D;">// channel 2 → blue</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">: { r: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">, g: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">, b: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">,   a: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;"> },   </span><span style="color:#6A737D;">// channel 3 → yellow</span></span>
<span class="line"><span style="color:#24292E;">});</span></span>
<span class="line"><span style="color:#6A737D;">// Triggers only one reloadMasksFromVolume() — more efficient than multiple setChannelColor() calls</span></span></code></pre></div><hr><p><strong>Scenario 3: Apply the same channel color across all layers</strong></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// Set channel 1 to red across all layers</span></span>
<span class="line"><span style="color:#E1E4E8;">nrrdTools.</span><span style="color:#B392F0;">setAllLayersChannelColor</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, { r: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">, g: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, b: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, a: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;"> });</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// Set channel 1 to red across all layers</span></span>
<span class="line"><span style="color:#24292E;">nrrdTools.</span><span style="color:#6F42C1;">setAllLayersChannelColor</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, { r: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">, g: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, b: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, a: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;"> });</span></span></code></pre></div><hr><p><strong>Scenario 4: Read the current color</strong></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">rgba</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nrrdTools.</span><span style="color:#B392F0;">getChannelColor</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;layer2&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#6A737D;">// → { r: 255, g: 128, b: 0, a: 255 }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">hex</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nrrdTools.</span><span style="color:#B392F0;">getChannelHexColor</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;layer2&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#6A737D;">// → &quot;#ff8000&quot;  (suitable for canvas fillStyle or CSS color)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">css</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> nrrdTools.</span><span style="color:#B392F0;">getChannelCssColor</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;layer2&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#6A737D;">// → &quot;rgba(255,128,0,1.00)&quot;  (suitable for Vue style binding)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">rgba</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nrrdTools.</span><span style="color:#6F42C1;">getChannelColor</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;layer2&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6A737D;">// → { r: 255, g: 128, b: 0, a: 255 }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">hex</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nrrdTools.</span><span style="color:#6F42C1;">getChannelHexColor</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;layer2&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6A737D;">// → &quot;#ff8000&quot;  (suitable for canvas fillStyle or CSS color)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">css</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> nrrdTools.</span><span style="color:#6F42C1;">getChannelCssColor</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;layer2&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#6A737D;">// → &quot;rgba(255,128,0,1.00)&quot;  (suitable for Vue style binding)</span></span></code></pre></div><hr><p><strong>Scenario 5: Reset colors</strong></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// Reset channel 3 of layer2 to default</span></span>
<span class="line"><span style="color:#E1E4E8;">nrrdTools.</span><span style="color:#B392F0;">resetChannelColors</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;layer2&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Reset all channels of layer2 to default</span></span>
<span class="line"><span style="color:#E1E4E8;">nrrdTools.</span><span style="color:#B392F0;">resetChannelColors</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;layer2&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Reset all channels of all layers to default</span></span>
<span class="line"><span style="color:#E1E4E8;">nrrdTools.</span><span style="color:#B392F0;">resetChannelColors</span><span style="color:#E1E4E8;">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// Reset channel 3 of layer2 to default</span></span>
<span class="line"><span style="color:#24292E;">nrrdTools.</span><span style="color:#6F42C1;">resetChannelColors</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;layer2&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Reset all channels of layer2 to default</span></span>
<span class="line"><span style="color:#24292E;">nrrdTools.</span><span style="color:#6F42C1;">resetChannelColors</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;layer2&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// Reset all channels of all layers to default</span></span>
<span class="line"><span style="color:#24292E;">nrrdTools.</span><span style="color:#6F42C1;">resetChannelColors</span><span style="color:#24292E;">();</span></span></code></pre></div><hr><p><strong>Scenario 6: Notify Vue UI to refresh after setting colors</strong></p><p>After a color change, the canvas re-renders automatically (<code>reloadMasksFromVolume()</code> is called automatically). However, Vue UI components showing channel color swatches need a manual nudge:</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// In a Vue component, get the refreshChannelColors function from the composable</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> { </span><span style="color:#79B8FF;">refreshChannelColors</span><span style="color:#E1E4E8;"> } </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">useLayerChannel</span><span style="color:#E1E4E8;">({ nrrdTools });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// After setting a color, call refresh to sync the Vue UI</span></span>
<span class="line"><span style="color:#E1E4E8;">nrrdTools.</span><span style="color:#B392F0;">setChannelColor</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;layer2&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">3</span><span style="color:#E1E4E8;">, { r: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">, g: </span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">, b: </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, a: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;"> });</span></span>
<span class="line"><span style="color:#B392F0;">refreshChannelColors</span><span style="color:#E1E4E8;">(); </span><span style="color:#6A737D;">// Increments colorVersion → triggers recomputation of dynamicChannelConfigs</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// In a Vue component, get the refreshChannelColors function from the composable</span></span>
<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> { </span><span style="color:#005CC5;">refreshChannelColors</span><span style="color:#24292E;"> } </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">useLayerChannel</span><span style="color:#24292E;">({ nrrdTools });</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D;">// After setting a color, call refresh to sync the Vue UI</span></span>
<span class="line"><span style="color:#24292E;">nrrdTools.</span><span style="color:#6F42C1;">setChannelColor</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;layer2&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">3</span><span style="color:#24292E;">, { r: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">, g: </span><span style="color:#005CC5;">128</span><span style="color:#24292E;">, b: </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, a: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;"> });</span></span>
<span class="line"><span style="color:#6F42C1;">refreshChannelColors</span><span style="color:#24292E;">(); </span><span style="color:#6A737D;">// Increments colorVersion → triggers recomputation of dynamicChannelConfigs</span></span></code></pre></div><p>Or listen to the <code>onChannelColorChanged</code> callback for automatic refresh:</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">// ⚠️ onChannelColorChanged is currently attached to nrrd_states and cannot be set directly from outside</span></span>
<span class="line"><span style="color:#6A737D;">// Recommended: manually call refreshChannelColors() after setChannelColor()</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">// ⚠️ onChannelColorChanged is currently attached to nrrd_states and cannot be set directly from outside</span></span>
<span class="line"><span style="color:#6A737D;">// Recommended: manually call refreshChannelColors() after setChannelColor()</span></span></code></pre></div><hr><p><strong>Scenario 7: Complete initialization + color setup example (in a Vue component)</strong></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">import</span><span style="color:#E1E4E8;"> emitter </span><span style="color:#F97583;">from</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;@/plugins/custom-emitter&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">nrrdTools</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ref</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">Copper</span><span style="color:#E1E4E8;">.</span><span style="color:#B392F0;">NrrdTools</span><span style="color:#E1E4E8;">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">emitter.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;Core:NrrdTools&#39;</span><span style="color:#E1E4E8;">, (</span><span style="color:#FFAB70;">tools</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  nrrdTools.value </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> tools;</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">emitter.</span><span style="color:#B392F0;">on</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;Segmentation:FinishLoadAllCaseImages&#39;</span><span style="color:#E1E4E8;">, () </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// At this point setAllSlices() is complete, MaskVolume is initialized</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (</span><span style="color:#F97583;">!</span><span style="color:#E1E4E8;">nrrdTools.value) </span><span style="color:#F97583;">return</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  nrrdTools.value.</span><span style="color:#B392F0;">setChannelColors</span><span style="color:#E1E4E8;">(</span><span style="color:#9ECBFF;">&#39;layer1&#39;</span><span style="color:#E1E4E8;">, {</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">: { r: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">, g: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">,  b: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">,  a: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;"> },   </span><span style="color:#6A737D;">// light red</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">2</span><span style="color:#E1E4E8;">: { r: </span><span style="color:#79B8FF;">80</span><span style="color:#E1E4E8;">,  g: </span><span style="color:#79B8FF;">180</span><span style="color:#E1E4E8;">, b: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;">, a: </span><span style="color:#79B8FF;">255</span><span style="color:#E1E4E8;"> },   </span><span style="color:#6A737D;">// light blue</span></span>
<span class="line"><span style="color:#E1E4E8;">  });</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#6A737D;">// layer2 keeps default colors — no action needed</span></span>
<span class="line"><span style="color:#E1E4E8;">});</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">import</span><span style="color:#24292E;"> emitter </span><span style="color:#D73A49;">from</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;@/plugins/custom-emitter&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">nrrdTools</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ref</span><span style="color:#24292E;">&lt;</span><span style="color:#6F42C1;">Copper</span><span style="color:#24292E;">.</span><span style="color:#6F42C1;">NrrdTools</span><span style="color:#24292E;">&gt;();</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">emitter.</span><span style="color:#6F42C1;">on</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;Core:NrrdTools&#39;</span><span style="color:#24292E;">, (</span><span style="color:#E36209;">tools</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  nrrdTools.value </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> tools;</span></span>
<span class="line"><span style="color:#24292E;">});</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">emitter.</span><span style="color:#6F42C1;">on</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;Segmentation:FinishLoadAllCaseImages&#39;</span><span style="color:#24292E;">, () </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// At this point setAllSlices() is complete, MaskVolume is initialized</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (</span><span style="color:#D73A49;">!</span><span style="color:#24292E;">nrrdTools.value) </span><span style="color:#D73A49;">return</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  nrrdTools.value.</span><span style="color:#6F42C1;">setChannelColors</span><span style="color:#24292E;">(</span><span style="color:#032F62;">&#39;layer1&#39;</span><span style="color:#24292E;">, {</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">: { r: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">, g: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">,  b: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">,  a: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;"> },   </span><span style="color:#6A737D;">// light red</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">2</span><span style="color:#24292E;">: { r: </span><span style="color:#005CC5;">80</span><span style="color:#24292E;">,  g: </span><span style="color:#005CC5;">180</span><span style="color:#24292E;">, b: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;">, a: </span><span style="color:#005CC5;">255</span><span style="color:#24292E;"> },   </span><span style="color:#6A737D;">// light blue</span></span>
<span class="line"><span style="color:#24292E;">  });</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6A737D;">// layer2 keeps default colors — no action needed</span></span>
<span class="line"><span style="color:#24292E;">});</span></span></code></pre></div><hr><p><strong>Color value range</strong></p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RGBAColor</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">r</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">;  </span><span style="color:#6A737D;">// 0-255</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">g</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">;  </span><span style="color:#6A737D;">// 0-255</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">b</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">;  </span><span style="color:#6A737D;">// 0-255</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">a</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">;  </span><span style="color:#6A737D;">// 0-255 (255 = fully opaque, 0 = fully transparent)</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RGBAColor</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">r</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">;  </span><span style="color:#6A737D;">// 0-255</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">g</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">;  </span><span style="color:#6A737D;">// 0-255</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">b</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">;  </span><span style="color:#6A737D;">// 0-255</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">a</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">;  </span><span style="color:#6A737D;">// 0-255 (255 = fully opaque, 0 = fully transparent)</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><p>The <code>a</code> (alpha) field determines the base mask opacity. Usually set to <code>255</code>; actual rendering multiplies by <code>gui_states.drawing.globalAlpha</code> (default 0.6).</p><h3 id="_2-3-keyboard-history" tabindex="-1">2.3 Keyboard &amp; History <a class="header-anchor" href="#_2-3-keyboard-history" aria-label="Permalink to &quot;2.3 Keyboard &amp; History&quot;">​</a></h3><blockquote><p><strong>Implementation</strong>: Directly in the NrrdTools Facade (section 4).</p></blockquote><table><thead><tr><th>Method</th><th>Signature</th><th>Description</th></tr></thead><tbody><tr><td><code>undo</code></td><td><code>(): void</code></td><td>Undo the last drawing operation</td></tr><tr><td><code>redo</code></td><td><code>(): void</code></td><td>Redo the last undone operation</td></tr><tr><td><code>enterKeyboardConfig</code></td><td><code>(): void</code></td><td>Suppress all shortcuts</td></tr><tr><td><code>exitKeyboardConfig</code></td><td><code>(): void</code></td><td>Restore shortcuts</td></tr><tr><td><code>setContrastShortcutEnabled</code></td><td><code>(enabled: boolean): void</code></td><td>Enable/disable the Contrast shortcut key</td></tr><tr><td><code>isContrastShortcutEnabled</code></td><td><code>(): boolean</code></td><td>Check if the Contrast shortcut is enabled</td></tr><tr><td><code>setKeyboardSettings</code></td><td><code>(settings: Partial&lt;IKeyBoardSettings&gt;): void</code></td><td>Update keyboard shortcut bindings</td></tr><tr><td><code>getKeyboardSettings</code></td><td><code>(): IKeyBoardSettings</code></td><td>Get a snapshot of current keyboard settings</td></tr></tbody></table><h3 id="_2-4-data-loading" tabindex="-1">2.4 Data Loading <a class="header-anchor" href="#_2-4-data-loading" aria-label="Permalink to &quot;2.4 Data Loading&quot;">​</a></h3><blockquote><p><strong>Implementation</strong>: <code>tools/DataLoader.ts</code>, single-line delegation in NrrdTools.</p></blockquote><table><thead><tr><th>Method</th><th>Signature</th><th>Description</th></tr></thead><tbody><tr><td><code>setAllSlices</code></td><td><code>(allSlices: Array&lt;nrrdSliceType&gt;): void</code></td><td><strong>Entry point</strong>: Load NRRD slices and initialize all MaskVolumes to the correct dimensions</td></tr><tr><td><code>setMasksData</code></td><td><code>(masksData, loadingBar?): void</code></td><td>Legacy loading method (deprecated, pending removal)</td></tr><tr><td><code>setMasksFromNIfTI</code></td><td><code>(layerVoxels: Map&lt;string, Uint8Array&gt;, loadingBar?): void</code></td><td>Load mask data from NIfTI files into MaskVolume</td></tr></tbody></table><h3 id="_2-5-display-rendering" tabindex="-1">2.5 Display &amp; Rendering <a class="header-anchor" href="#_2-5-display-rendering" aria-label="Permalink to &quot;2.5 Display &amp; Rendering&quot;">​</a></h3><blockquote><p><strong>Implementation</strong>: <code>tools/SliceRenderPipeline.ts</code>, single-line delegation in NrrdTools.</p></blockquote><table><thead><tr><th>Method</th><th>Signature</th><th>Description</th></tr></thead><tbody><tr><td><code>resizePaintArea</code></td><td><code>(factor: number): void</code></td><td>Resize the canvas scale factor</td></tr><tr><td><code>reloadMasksFromVolume</code></td><td><code>(): void</code> (private)</td><td><strong>Core re-render</strong>: Re-renders all Layers from MaskVolume to Canvas</td></tr><tr><td><code>flipDisplayImageByAxis</code></td><td><code>(): void</code></td><td>Flip the CT image for correct display orientation</td></tr><tr><td><code>redrawDisplayCanvas</code></td><td><code>(): void</code></td><td>Redraw the contrast image onto the displayCanvas</td></tr><tr><td><code>setEmptyCanvasSize</code></td><td><code>(axis?): void</code></td><td>Set emptyCanvas dimensions based on the current axis</td></tr></tbody></table><h3 id="_2-6-programmatic-sphere-placement" tabindex="-1">2.6 Programmatic Sphere Placement <a class="header-anchor" href="#_2-6-programmatic-sphere-placement" aria-label="Permalink to &quot;2.6 Programmatic Sphere Placement&quot;">​</a></h3><table><thead><tr><th>Method</th><th>Signature</th><th>Description</th></tr></thead><tbody><tr><td><code>setCalculateDistanceSphere</code></td><td><code>(x: number, y: number, sliceIndex: number, cal_position: SphereType): void</code></td><td>Programmatically place a calculator sphere, simulating a full mouse click flow</td></tr></tbody></table><p><strong>Parameters:</strong></p><ul><li><code>x</code>, <code>y</code> — Unscaled image-space coordinates (the method applies <code>sizeFactor</code> internally)</li><li><code>sliceIndex</code> — Target slice index</li><li><code>cal_position</code> — Sphere type: <code>&quot;tumour&quot;</code> / <code>&quot;skin&quot;</code> / <code>&quot;nipple&quot;</code> / <code>&quot;ribcage&quot;</code></li></ul><p><strong>Internal flow</strong> (simulates <code>DrawToolCore.handleSphereClick</code> + <code>pointerup</code>):</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">setCalculateDistanceSphere(x, y, sliceIndex, cal_position)</span></span>
<span class="line"><span style="color:#e1e4e8;">  │</span></span>
<span class="line"><span style="color:#e1e4e8;">  ├─ sphereRadius = 5</span></span>
<span class="line"><span style="color:#e1e4e8;">  ├─ setSliceMoving(...)                          → navigate to target slice</span></span>
<span class="line"><span style="color:#e1e4e8;">  │</span></span>
<span class="line"><span style="color:#e1e4e8;">  ├─ --- simulate mouse-down ---</span></span>
<span class="line"><span style="color:#e1e4e8;">  │  ├─ mouseX = x * sizeFactor</span></span>
<span class="line"><span style="color:#e1e4e8;">  │  ├─ sphereOrigin[axis] = [mouseX, mouseY, sliceIndex]</span></span>
<span class="line"><span style="color:#e1e4e8;">  │  ├─ crosshairTool.setUpSphereOrigins(...)     → compute origins on all 3 axes</span></span>
<span class="line"><span style="color:#e1e4e8;">  │  ├─ tumourSphereOrigin = deepCopy(sphereOrigin)  → store by cal_position type</span></span>
<span class="line"><span style="color:#e1e4e8;">  │  └─ drawCalculatorSphere(radius)              → draw preview</span></span>
<span class="line"><span style="color:#e1e4e8;">  │</span></span>
<span class="line"><span style="color:#e1e4e8;">  └─ --- simulate mouse-up ---</span></span>
<span class="line"><span style="color:#e1e4e8;">     ├─ sphereTool.writeAllCalculatorSpheresToVolume()  → write to sphereMaskVolume</span></span>
<span class="line"><span style="color:#e1e4e8;">     └─ sphereTool.refreshSphereCanvas()               → re-render overlay</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">setCalculateDistanceSphere(x, y, sliceIndex, cal_position)</span></span>
<span class="line"><span style="color:#24292e;">  │</span></span>
<span class="line"><span style="color:#24292e;">  ├─ sphereRadius = 5</span></span>
<span class="line"><span style="color:#24292e;">  ├─ setSliceMoving(...)                          → navigate to target slice</span></span>
<span class="line"><span style="color:#24292e;">  │</span></span>
<span class="line"><span style="color:#24292e;">  ├─ --- simulate mouse-down ---</span></span>
<span class="line"><span style="color:#24292e;">  │  ├─ mouseX = x * sizeFactor</span></span>
<span class="line"><span style="color:#24292e;">  │  ├─ sphereOrigin[axis] = [mouseX, mouseY, sliceIndex]</span></span>
<span class="line"><span style="color:#24292e;">  │  ├─ crosshairTool.setUpSphereOrigins(...)     → compute origins on all 3 axes</span></span>
<span class="line"><span style="color:#24292e;">  │  ├─ tumourSphereOrigin = deepCopy(sphereOrigin)  → store by cal_position type</span></span>
<span class="line"><span style="color:#24292e;">  │  └─ drawCalculatorSphere(radius)              → draw preview</span></span>
<span class="line"><span style="color:#24292e;">  │</span></span>
<span class="line"><span style="color:#24292e;">  └─ --- simulate mouse-up ---</span></span>
<span class="line"><span style="color:#24292e;">     ├─ sphereTool.writeAllCalculatorSpheresToVolume()  → write to sphereMaskVolume</span></span>
<span class="line"><span style="color:#24292e;">     └─ sphereTool.refreshSphereCanvas()               → re-render overlay</span></span></code></pre></div><p><strong>Typical usage</strong> (called after backend returns sphere coordinates):</p><div class="language-typescript vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">typescript</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">nrrdTools.</span><span style="color:#B392F0;">setCalculateDistanceSphere</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">120</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">95</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">42</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;tumour&#39;</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">nrrdTools.</span><span style="color:#B392F0;">setCalculateDistanceSphere</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">200</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">150</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">42</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;skin&#39;</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">nrrdTools.</span><span style="color:#6F42C1;">setCalculateDistanceSphere</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">120</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">95</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">42</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;tumour&#39;</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">nrrdTools.</span><span style="color:#6F42C1;">setCalculateDistanceSphere</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">200</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">150</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">42</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;skin&#39;</span><span style="color:#24292E;">);</span></span></code></pre></div><h3 id="_2-7-other-apis" tabindex="-1">2.7 Other APIs <a class="header-anchor" href="#_2-7-other-apis" aria-label="Permalink to &quot;2.7 Other APIs&quot;">​</a></h3><blockquote><p><strong>Implementation</strong>: Directly in the NrrdTools Facade (section 5 View Control, section 6 Data Getters).</p></blockquote><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td><code>drag(opts?)</code></td><td>Enable drag-to-scroll slice navigation</td></tr><tr><td><code>setBaseDrawDisplayCanvasesSize(size)</code></td><td>Set canvas base size multiplier (1–8)</td></tr><tr><td><code>setupGUI(gui)</code></td><td>Set up the dat.GUI panel</td></tr><tr><td><code>enableContrastDragEvents(callback)</code></td><td>Enable contrast drag (window/level) events</td></tr><tr><td><code>getCurrentImageDimension()</code></td><td>Get voxel dimensions <code>[w, h, d]</code></td></tr><tr><td><code>getVoxelSpacing()</code></td><td>Get voxel spacing (mm)</td></tr><tr><td><code>getSpaceOrigin()</code></td><td>Get world-space origin</td></tr><tr><td><code>getMaxSliceNum()</code></td><td>Get max slice count per axis</td></tr><tr><td><code>getCurrentSlicesNumAndContrastNum()</code></td><td>Get current slice index and contrast index</td></tr><tr><td><code>getMaskData()</code></td><td>Get raw <code>IMaskData</code> structure</td></tr><tr><td><code>getContainer()</code></td><td>Get the internal main-area container element</td></tr><tr><td><code>getDrawingCanvas()</code></td><td>Get the top-level interactive canvas</td></tr><tr><td><code>getNrrdToolsSettings()</code></td><td>Get a full NrrdState snapshot (5 sub-objects)</td></tr></tbody></table><hr><h2 id="_3-states" tabindex="-1">3. States <a class="header-anchor" href="#_3-states" aria-label="Permalink to &quot;3. States&quot;">​</a></h2><h3 id="_3-1-nrrd-states-nrrdstate" tabindex="-1">3.1 nrrd_states (NrrdState) <a class="header-anchor" href="#_3-1-nrrd-states-nrrdstate" aria-label="Permalink to &quot;3.1 nrrd_states (NrrdState)&quot;">​</a></h3><p><strong>Type</strong>: <code>NrrdState</code> class (defined in <code>coreTools/NrrdState.ts</code>) <strong>Interface</strong>: <code>INrrdStates</code> extends <code>IImageMetadata</code>, <code>IViewState</code>, <code>IInteractionState</code>, <code>ISphereState</code>, <code>IInternalFlags</code> (defined in <code>core/types.ts</code>)</p><p>NrrdState groups 44 properties into 5 semantic sub-objects:</p><h4 id="nrrd-states-image-iimagemetadata" tabindex="-1">nrrd_states.image (IImageMetadata) <a class="header-anchor" href="#nrrd-states-image-iimagemetadata" aria-label="Permalink to &quot;nrrd_states.image (IImageMetadata)&quot;">​</a></h4><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>dimensions</code></td><td><code>[width, height, depth]</code></td><td>Voxel dimensions</td></tr><tr><td><code>nrrd_x_pixel</code> / <code>y</code> / <code>z</code></td><td><code>number</code></td><td>Pixel count per axis</td></tr><tr><td><code>voxelSpacing</code></td><td><code>number[]</code></td><td>Voxel spacing</td></tr><tr><td><code>spaceOrigin</code></td><td><code>number[]</code></td><td>World-space origin</td></tr><tr><td><code>layers</code></td><td><code>string[]</code></td><td>List of Layer IDs</td></tr></tbody></table><h4 id="nrrd-states-view-iviewstate" tabindex="-1">nrrd_states.view (IViewState) <a class="header-anchor" href="#nrrd-states-view-iviewstate" aria-label="Permalink to &quot;nrrd_states.view (IViewState)&quot;">​</a></h4><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>currentSliceIndex</code></td><td><code>number</code></td><td>Current slice index</td></tr><tr><td><code>maxIndex</code> / <code>minIndex</code></td><td><code>number</code></td><td>Slice index range</td></tr><tr><td><code>changedWidth</code> / <code>changedHeight</code></td><td><code>number</code></td><td>Canvas display dimensions</td></tr><tr><td><code>sizeFactor</code></td><td><code>number</code></td><td>Scale factor</td></tr><tr><td><code>originWidth</code> / <code>originHeight</code></td><td><code>number</code></td><td>Original image dimensions</td></tr></tbody></table><h4 id="nrrd-states-interaction-iinteractionstate" tabindex="-1">nrrd_states.interaction (IInteractionState) <a class="header-anchor" href="#nrrd-states-interaction-iinteractionstate" aria-label="Permalink to &quot;nrrd_states.interaction (IInteractionState)&quot;">​</a></h4><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>mouseOverX</code> / <code>mouseOverY</code></td><td><code>number</code></td><td>Mouse position</td></tr><tr><td><code>mouseOver</code></td><td><code>boolean</code></td><td>Whether mouse is over the canvas</td></tr><tr><td><code>cursorPageX</code> / <code>cursorPageY</code></td><td><code>number</code></td><td>Cursor page coordinates</td></tr><tr><td><code>drawStartPos</code></td><td><code>ICommXY</code></td><td>Drawing start point</td></tr></tbody></table><h4 id="nrrd-states-sphere-ispherestate" tabindex="-1">nrrd_states.sphere (ISphereState) <a class="header-anchor" href="#nrrd-states-sphere-ispherestate" aria-label="Permalink to &quot;nrrd_states.sphere (ISphereState)&quot;">​</a></h4><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>sphereOrigin</code> / <code>skinSphereOrigin</code> etc.</td><td><code>ICommXYZ | null</code></td><td>Origin for each sphere type</td></tr><tr><td><code>sphereRadius</code></td><td><code>number</code></td><td>Sphere radius</td></tr><tr><td><code>sphereMaskVolume</code></td><td><code>MaskVolume | null</code></td><td>Sphere volumetric data</td></tr></tbody></table><h4 id="nrrd-states-flags-iinternalflags" tabindex="-1">nrrd_states.flags (IInternalFlags) <a class="header-anchor" href="#nrrd-states-flags-iinternalflags" aria-label="Permalink to &quot;nrrd_states.flags (IInternalFlags)&quot;">​</a></h4><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>stepClear</code></td><td><code>number</code></td><td>Clear step (internal use)</td></tr><tr><td><code>clearAllFlag</code></td><td><code>boolean</code></td><td>Whether the current operation is a full-layer clear</td></tr><tr><td><code>loadingMaskData</code></td><td><code>boolean</code></td><td>Whether mask data is currently being loaded</td></tr></tbody></table><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>The <code>loadMaskByDefault</code> and <code>isCalcContrastByDrag</code> fields <strong>no longer exist</strong> — previous documentation was incorrect.</p><p><code>INrrdStates</code> flat interface is kept for backward compatibility (extends all 5 sub-interfaces), but at runtime the <code>NrrdState</code> class instance is used, with properties accessed via <code>nrrd_states.image.xxx</code>, <code>nrrd_states.view.xxx</code>, etc.</p></div><h3 id="_3-2-gui-states-guistate" tabindex="-1">3.2 gui_states (GuiState) <a class="header-anchor" href="#_3-2-gui-states-guistate" aria-label="Permalink to &quot;3.2 gui_states (GuiState)&quot;">​</a></h3><p><strong>Type</strong>: <code>GuiState</code> class (defined in <code>coreTools/GuiState.ts</code>) <strong>Interface</strong>: <code>IGUIStates</code> extends <code>IToolModeState</code>, <code>IDrawingConfig</code>, <code>IViewConfig</code>, <code>ILayerChannelState</code> (defined in <code>core/types.ts</code>)</p><p>GuiState groups 20 properties into 4 semantic sub-objects:</p><h4 id="gui-states-mode-itoolmodestate" tabindex="-1">gui_states.mode (IToolModeState) <a class="header-anchor" href="#gui-states-mode-itoolmodestate" aria-label="Permalink to &quot;gui_states.mode (IToolModeState)&quot;">​</a></h4><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>pencil</code></td><td><code>boolean</code></td><td>Pencil tool active</td></tr><tr><td><code>eraser</code></td><td><code>boolean</code></td><td>Eraser tool active</td></tr><tr><td><code>sphere</code></td><td><code>boolean</code></td><td>Sphere tool active</td></tr><tr><td><code>activeSphereType</code></td><td><code>&quot;tumour&quot; | &quot;skin&quot; | &quot;nipple&quot; | &quot;ribcage&quot;</code></td><td>Current sphere type</td></tr></tbody></table><h4 id="gui-states-drawing-idrawingconfig" tabindex="-1">gui_states.drawing (IDrawingConfig) <a class="header-anchor" href="#gui-states-drawing-idrawingconfig" aria-label="Permalink to &quot;gui_states.drawing (IDrawingConfig)&quot;">​</a></h4><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>globalAlpha</code></td><td><code>number</code></td><td>Global opacity (default 0.6)</td></tr><tr><td><code>lineWidth</code></td><td><code>number</code></td><td>Line width</td></tr><tr><td><code>color</code> / <code>fillColor</code> / <code>brushColor</code></td><td><code>string</code></td><td>Brush color (Hex)</td></tr><tr><td><code>brushAndEraserSize</code></td><td><code>number</code></td><td>Brush/eraser size</td></tr></tbody></table><h4 id="gui-states-viewconfig-iviewconfig" tabindex="-1">gui_states.viewConfig (IViewConfig) <a class="header-anchor" href="#gui-states-viewconfig-iviewconfig" aria-label="Permalink to &quot;gui_states.viewConfig (IViewConfig)&quot;">​</a></h4><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>mainAreaSize</code></td><td><code>number</code></td><td>Main area size</td></tr><tr><td><code>dragSensitivity</code></td><td><code>number</code></td><td>Drag sensitivity</td></tr><tr><td><code>cursor</code> / <code>defaultPaintCursor</code></td><td><code>string</code></td><td>Cursor style</td></tr><tr><td><code>readyToUpdate</code></td><td><code>boolean</code></td><td>Ready-to-update flag</td></tr></tbody></table><h4 id="gui-states-layerchannel-ilayerchannelstate" tabindex="-1">gui_states.layerChannel (ILayerChannelState) <a class="header-anchor" href="#gui-states-layerchannel-ilayerchannelstate" aria-label="Permalink to &quot;gui_states.layerChannel (ILayerChannelState)&quot;">​</a></h4><table><thead><tr><th>Field</th><th>Type</th><th>Description</th></tr></thead><tbody><tr><td><code>layer</code></td><td><code>string</code></td><td>Currently active Layer (default <code>&quot;layer1&quot;</code>)</td></tr><tr><td><code>activeChannel</code></td><td><code>number</code></td><td>Currently active Channel (1–8)</td></tr><tr><td><code>layerVisibility</code></td><td><code>Record&lt;string, boolean&gt;</code></td><td>Layer visibility map</td></tr><tr><td><code>channelVisibility</code></td><td><code>Record&lt;string, Record&lt;number, boolean&gt;&gt;</code></td><td>Channel visibility map</td></tr></tbody></table><h3 id="_3-3-protecteddata-iprotected" tabindex="-1">3.3 protectedData (IProtected) <a class="header-anchor" href="#_3-3-protecteddata-iprotected" aria-label="Permalink to &quot;3.3 protectedData (IProtected)&quot;">​</a></h3><p>Defined in <code>CanvasState.ts</code> constructor.</p><table><thead><tr><th>Field</th><th>Description</th></tr></thead><tbody><tr><td><code>axis</code></td><td>Current viewing axis <code>&quot;x&quot;</code> / <code>&quot;y&quot;</code> / <code>&quot;z&quot;</code></td></tr><tr><td><code>maskData.volumes</code></td><td><code>Record&lt;string, MaskVolume&gt;</code> — 3D volume for each Layer</td></tr><tr><td><code>layerTargets</code></td><td><code>Map&lt;string, ILayerRenderTarget&gt;</code> — canvas + ctx for each Layer</td></tr><tr><td><code>canvases</code></td><td>5 system canvases</td></tr><tr><td><code>ctxes</code></td><td>Corresponding 2D contexts</td></tr><tr><td><code>isDrawing</code></td><td>Whether drawing is currently active</td></tr></tbody></table><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p><code>Is_Shift_Pressed</code> / <code>Is_Ctrl_Pressed</code> have been removed. Keyboard modifier key state is now managed internally by <code>EventRouter</code> and is no longer exposed through <code>protectedData</code>.</p></div><hr><h2 id="_4-callbacks" tabindex="-1">4. Callbacks <a class="header-anchor" href="#_4-callbacks" aria-label="Permalink to &quot;4. Callbacks&quot;">​</a></h2><h3 id="_4-1-onmaskchanged-getmaskdata-backend-sync" tabindex="-1">4.1 onMaskChanged / getMaskData (backend sync) <a class="header-anchor" href="#_4-1-onmaskchanged-getmaskdata-backend-sync" aria-label="Permalink to &quot;4.1 onMaskChanged / getMaskData (backend sync)&quot;">​</a></h3><p>Storage location: <code>CanvasState.annotationCallbacks.onMaskChanged</code> (<code>IAnnotationCallbacks</code> interface)</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>The <code>nrrd_states.getMask</code> field referenced in previous documentation <strong>no longer exists</strong>. Register externally via <code>nrrdTools.draw({ getMaskData: ... })</code>, which maps internally to <code>annotationCallbacks.onMaskChanged</code>.</p></div><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">onMaskChanged</span><span style="color:#E1E4E8;">: (</span></span>
<span class="line"><span style="color:#E1E4E8;">  sliceData: Uint8Array,    </span><span style="color:#6A737D;">// Raw voxel data for the current slice</span></span>
<span class="line"><span style="color:#E1E4E8;">  layerId: string,          </span><span style="color:#6A737D;">// Layer name</span></span>
<span class="line"><span style="color:#E1E4E8;">  channelId: number,        </span><span style="color:#6A737D;">// Active channel</span></span>
<span class="line"><span style="color:#E1E4E8;">  sliceIndex: number,       </span><span style="color:#6A737D;">// Slice index</span></span>
<span class="line"><span style="color:#E1E4E8;">  axis: </span><span style="color:#9ECBFF;">&quot;x&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;y&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;z&quot;</span><span style="color:#E1E4E8;">,   </span><span style="color:#6A737D;">// Current axis</span></span>
<span class="line"><span style="color:#E1E4E8;">  width: number,            </span><span style="color:#6A737D;">// Slice width</span></span>
<span class="line"><span style="color:#E1E4E8;">  height: number,           </span><span style="color:#6A737D;">// Slice height</span></span>
<span class="line"><span style="color:#E1E4E8;">  clearFlag: boolean        </span><span style="color:#6A737D;">// Whether this is a clear operation</span></span>
<span class="line"><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">onMaskChanged</span><span style="color:#24292E;">: (</span></span>
<span class="line"><span style="color:#24292E;">  sliceData: Uint8Array,    </span><span style="color:#6A737D;">// Raw voxel data for the current slice</span></span>
<span class="line"><span style="color:#24292E;">  layerId: string,          </span><span style="color:#6A737D;">// Layer name</span></span>
<span class="line"><span style="color:#24292E;">  channelId: number,        </span><span style="color:#6A737D;">// Active channel</span></span>
<span class="line"><span style="color:#24292E;">  sliceIndex: number,       </span><span style="color:#6A737D;">// Slice index</span></span>
<span class="line"><span style="color:#24292E;">  axis: </span><span style="color:#032F62;">&quot;x&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;y&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;z&quot;</span><span style="color:#24292E;">,   </span><span style="color:#6A737D;">// Current axis</span></span>
<span class="line"><span style="color:#24292E;">  width: number,            </span><span style="color:#6A737D;">// Slice width</span></span>
<span class="line"><span style="color:#24292E;">  height: number,           </span><span style="color:#6A737D;">// Slice height</span></span>
<span class="line"><span style="color:#24292E;">  clearFlag: boolean        </span><span style="color:#6A737D;">// Whether this is a clear operation</span></span>
<span class="line"><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span></span></code></pre></div><p><strong>Called</strong>: After each completed drawing stroke (mouseup), and after undo/redo.</p><h3 id="_4-2-onlayervolumecleared" tabindex="-1">4.2 onLayerVolumeCleared <a class="header-anchor" href="#_4-2-onlayervolumecleared" aria-label="Permalink to &quot;4.2 onLayerVolumeCleared&quot;">​</a></h3><p>Storage location: <code>CanvasState.annotationCallbacks.onLayerVolumeCleared</code></p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">onLayerVolumeCleared</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">layerId</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">onLayerVolumeCleared</span><span style="color:#24292E;">: (</span><span style="color:#E36209;">layerId</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span></span></code></pre></div><h3 id="_4-3-onchannelcolorchanged" tabindex="-1">4.3 onChannelColorChanged <a class="header-anchor" href="#_4-3-onchannelcolorchanged" aria-label="Permalink to &quot;4.3 onChannelColorChanged&quot;">​</a></h3><p>Storage location: <code>CanvasState.annotationCallbacks.onChannelColorChanged</code> (<code>IAnnotationCallbacks</code>, <code>core/types.ts</code>)</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>Previous documentation stated this was defined on <code>INrrdStates</code> — <strong>that is incorrect</strong>. This callback now belongs to <code>IAnnotationCallbacks</code>, stored in <code>CanvasState.annotationCallbacks</code>.</p></div><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">onChannelColorChanged</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">layerId</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">channel</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">, </span><span style="color:#FFAB70;">color</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">RGBAColor</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">onChannelColorChanged</span><span style="color:#24292E;">: (</span><span style="color:#E36209;">layerId</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string</span><span style="color:#24292E;">, </span><span style="color:#E36209;">channel</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">, </span><span style="color:#E36209;">color</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">RGBAColor</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span></span></code></pre></div><p><strong>Called</strong>: After <code>NrrdTools.setChannelColor()</code> modifies a color. Default is a no-op. Currently cannot be registered directly from outside — recommended approach: manually call <code>refreshChannelColors()</code> after <code>setChannelColor()</code>.</p><h3 id="_4-4-onspherechanged-oncalculatorpositionschanged" tabindex="-1">4.4 onSphereChanged / onCalculatorPositionsChanged <a class="header-anchor" href="#_4-4-onspherechanged-oncalculatorpositionschanged" aria-label="Permalink to &quot;4.4 onSphereChanged / onCalculatorPositionsChanged&quot;">​</a></h3><p>Storage location: <code>CanvasState.annotationCallbacks</code> (<code>IAnnotationCallbacks</code>, registered externally via <code>draw()</code>)</p><p><strong><code>onSphereChanged</code></strong> (<code>getSphereData</code> in <code>IDrawOpts</code>): Called when the left mouse button is released in sphere mode.</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">onSphereChanged</span><span style="color:#E1E4E8;">: (</span><span style="color:#FFAB70;">sphereOrigin</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">[], </span><span style="color:#FFAB70;">sphereRadius</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span></span>
<span class="line"><span style="color:#6A737D;">// sphereOrigin = [mouseX, mouseY, sliceIndex] — z-axis view coordinates</span></span>
<span class="line"><span style="color:#6A737D;">// sphereRadius = radius in pixels (1–50)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">onSphereChanged</span><span style="color:#24292E;">: (</span><span style="color:#E36209;">sphereOrigin</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">[], </span><span style="color:#E36209;">sphereRadius</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span></span>
<span class="line"><span style="color:#6A737D;">// sphereOrigin = [mouseX, mouseY, sliceIndex] — z-axis view coordinates</span></span>
<span class="line"><span style="color:#6A737D;">// sphereRadius = radius in pixels (1–50)</span></span></code></pre></div><p><strong><code>onCalculatorPositionsChanged</code></strong> (<code>getCalculateSpherePositionsData</code> in <code>IDrawOpts</code>): Called after a sphere is placed (applies to all sphere types).</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">onCalculatorPositionsChanged</span><span style="color:#E1E4E8;">: (</span></span>
<span class="line"><span style="color:#E1E4E8;">  tumourSphereOrigin: ICommXYZ </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">// channel 1</span></span>
<span class="line"><span style="color:#E1E4E8;">  skinSphereOrigin: ICommXYZ </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">,    </span><span style="color:#6A737D;">// channel 4</span></span>
<span class="line"><span style="color:#E1E4E8;">  ribSphereOrigin: ICommXYZ </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">,     </span><span style="color:#6A737D;">// channel 3</span></span>
<span class="line"><span style="color:#E1E4E8;">  nippleSphereOrigin: ICommXYZ </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">null</span><span style="color:#E1E4E8;">,  </span><span style="color:#6A737D;">// channel 2</span></span>
<span class="line"><span style="color:#E1E4E8;">  axis: </span><span style="color:#9ECBFF;">&quot;x&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;y&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;z&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">=&gt;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">void</span></span>
<span class="line"><span style="color:#6A737D;">// Each origin is { x: [mx, my, slice], y: [...], z: [...] }</span></span>
<span class="line"><span style="color:#6A737D;">// null means that sphere type has not yet been placed</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">onCalculatorPositionsChanged</span><span style="color:#24292E;">: (</span></span>
<span class="line"><span style="color:#24292E;">  tumourSphereOrigin: ICommXYZ </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">// channel 1</span></span>
<span class="line"><span style="color:#24292E;">  skinSphereOrigin: ICommXYZ </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">,    </span><span style="color:#6A737D;">// channel 4</span></span>
<span class="line"><span style="color:#24292E;">  ribSphereOrigin: ICommXYZ </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">,     </span><span style="color:#6A737D;">// channel 3</span></span>
<span class="line"><span style="color:#24292E;">  nippleSphereOrigin: ICommXYZ </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">null</span><span style="color:#24292E;">,  </span><span style="color:#6A737D;">// channel 2</span></span>
<span class="line"><span style="color:#24292E;">  axis: </span><span style="color:#032F62;">&quot;x&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;y&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;z&quot;</span></span>
<span class="line"><span style="color:#24292E;">) </span><span style="color:#D73A49;">=&gt;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">void</span></span>
<span class="line"><span style="color:#6A737D;">// Each origin is { x: [mx, my, slice], y: [...], z: [...] }</span></span>
<span class="line"><span style="color:#6A737D;">// null means that sphere type has not yet been placed</span></span></code></pre></div><p><strong>Channel mapping</strong> (exported as <code>SPHERE_CHANNEL_MAP</code>):</p><table><thead><tr><th>Sphere Type</th><th>Layer</th><th>Channel</th><th>Color</th></tr></thead><tbody><tr><td>tumour</td><td>layer1</td><td>1</td><td><code>#10b981</code> (Emerald)</td></tr><tr><td>nipple</td><td>layer1</td><td>2</td><td><code>#f43f5e</code> (Rose)</td></tr><tr><td>ribcage</td><td>layer1</td><td>3</td><td><code>#3b82f6</code> (Blue)</td></tr><tr><td>skin</td><td>layer1</td><td>4</td><td><code>#fbbf24</code> (Amber)</td></tr></tbody></table><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Sphere data currently does not write to the layer MaskVolume — it is displayed as an overlay only. The channel mapping is reserved for future integration.</p></div><hr><h2 id="_5-maskvolume-storage-rendering" tabindex="-1">5. MaskVolume Storage &amp; Rendering <a class="header-anchor" href="#_5-maskvolume-storage-rendering" aria-label="Permalink to &quot;5. MaskVolume Storage &amp; Rendering&quot;">​</a></h2><h3 id="_5-1-memory-layout" tabindex="-1">5.1 Memory Layout <a class="header-anchor" href="#_5-1-memory-layout" aria-label="Permalink to &quot;5.1 Memory Layout&quot;">​</a></h3><p><strong>File</strong>: <code>core/MaskVolume.ts</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">Memory layout: [z][y][x][channel]</span></span>
<span class="line"><span style="color:#e1e4e8;">index = z * bytesPerSlice + y * width * channels + x * channels + channel</span></span>
<span class="line"><span style="color:#e1e4e8;">bytesPerSlice = width * height * channels</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">Memory layout: [z][y][x][channel]</span></span>
<span class="line"><span style="color:#24292e;">index = z * bytesPerSlice + y * width * channels + x * channels + channel</span></span>
<span class="line"><span style="color:#24292e;">bytesPerSlice = width * height * channels</span></span></code></pre></div><p>Underlying data structure: a single contiguous <code>Uint8Array</code></p><h3 id="_5-2-slice-dimensions-per-axis" tabindex="-1">5.2 Slice Dimensions per Axis <a class="header-anchor" href="#_5-2-slice-dimensions-per-axis" aria-label="Permalink to &quot;5.2 Slice Dimensions per Axis&quot;">​</a></h3><table><thead><tr><th>Axis</th><th>Slice Width</th><th>Slice Height</th><th>Notes</th></tr></thead><tbody><tr><td>z (Axial)</td><td>width</td><td>height</td><td>Most common, contiguous memory</td></tr><tr><td>y (Coronal)</td><td>width</td><td>depth</td><td>Extracted row by row</td></tr><tr><td>x (Sagittal)</td><td>depth</td><td>height</td><td>Extracted pixel by pixel, slowest</td></tr></tbody></table><p>emptyCanvas size configuration: <code>SliceRenderPipeline.setEmptyCanvasSize()</code> → <code>tools/SliceRenderPipeline.ts</code></p><h3 id="_5-3-slice-extraction-reading-mask" tabindex="-1">5.3 Slice Extraction (reading mask) <a class="header-anchor" href="#_5-3-slice-extraction-reading-mask" aria-label="Permalink to &quot;5.3 Slice Extraction (reading mask)&quot;">​</a></h3><p><strong><code>getSliceUint8(sliceIndex, axis)</code></strong></p><p>Returns a raw <code>Uint8Array</code>, used for backend sync and Undo/Redo snapshots.</p><p>Per-axis implementation:</p><ul><li><strong>Z axis</strong>: Contiguous memory <code>subarray</code> bulk copy (fastest)</li><li><strong>Y axis</strong>: Row-by-row iteration copy</li><li><strong>X axis</strong>: Pixel-by-pixel extraction (slowest)</li></ul><h3 id="_5-4-slice-write" tabindex="-1">5.4 Slice Write <a class="header-anchor" href="#_5-4-slice-write" aria-label="Permalink to &quot;5.4 Slice Write&quot;">​</a></h3><p><strong><code>setSliceUint8(sliceIndex, data, axis)</code></strong> — Inverse of <code>getSliceUint8</code>, used for Undo/Redo restoration.</p><p><strong><code>setSliceLabelsFromImageData(sliceIndex, imageData, axis, activeChannel, channelVisible?)</code></strong> — Canvas → Volume write: converts RGBA pixels into channel labels (1–8). Uses <code>ALPHA_THRESHOLD = 128</code> to avoid anti-aliasing edge artifacts.</p><h3 id="_5-5-rendering-to-canvas" tabindex="-1">5.5 Rendering to Canvas <a class="header-anchor" href="#_5-5-rendering-to-canvas" aria-label="Permalink to &quot;5.5 Rendering to Canvas&quot;">​</a></h3><p><strong>Core render method: <code>renderLabelSliceInto()</code></strong></p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">renderLabelSliceInto</span><span style="color:#E1E4E8;">(</span></span>
<span class="line"><span style="color:#E1E4E8;">  sliceIndex: number,</span></span>
<span class="line"><span style="color:#E1E4E8;">  axis: </span><span style="color:#9ECBFF;">&#39;x&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;y&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;z&#39;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  target: ImageData,</span></span>
<span class="line"><span style="color:#E1E4E8;">  channelVisible</span><span style="color:#F97583;">?:</span><span style="color:#E1E4E8;"> Record</span><span style="color:#F97583;">&lt;</span><span style="color:#E1E4E8;">number, boolean</span><span style="color:#F97583;">&gt;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  opacity: number </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1.0</span></span>
<span class="line"><span style="color:#E1E4E8;">): </span><span style="color:#F97583;">void</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">renderLabelSliceInto</span><span style="color:#24292E;">(</span></span>
<span class="line"><span style="color:#24292E;">  sliceIndex: number,</span></span>
<span class="line"><span style="color:#24292E;">  axis: </span><span style="color:#032F62;">&#39;x&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;y&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;z&#39;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  target: ImageData,</span></span>
<span class="line"><span style="color:#24292E;">  channelVisible</span><span style="color:#D73A49;">?:</span><span style="color:#24292E;"> Record</span><span style="color:#D73A49;">&lt;</span><span style="color:#24292E;">number, boolean</span><span style="color:#D73A49;">&gt;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  opacity: number </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1.0</span></span>
<span class="line"><span style="color:#24292E;">): </span><span style="color:#D73A49;">void</span></span></code></pre></div><p>Rendering logic:</p><ol><li>Read label value (0–8)</li><li><code>label === 0</code> → transparent (RGBA all zero)</li><li><code>channelVisible &amp;&amp; !channelVisible[label]</code> → hidden channel → transparent</li><li>Otherwise → read color from volume&#39;s <code>colorMap</code> (supports per-layer custom colors), apply opacity</li></ol><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><strong>Phase B change</strong>: Color source changed from global <code>MASK_CHANNEL_COLORS</code> to each volume instance&#39;s <code>this.colorMap</code>. <code>buildRgbToChannelMap()</code> is also now an instance method, ensuring correct custom color mapping during canvas → volume write-back.</p></div><h3 id="_5-6-full-rendering-pipeline" tabindex="-1">5.6 Full Rendering Pipeline <a class="header-anchor" href="#_5-6-full-rendering-pipeline" aria-label="Permalink to &quot;5.6 Full Rendering Pipeline&quot;">​</a></h3><p><strong>Entry point: <code>reloadMasksFromVolume()</code></strong> — <code>SliceRenderPipeline.reloadMasksFromVolume()</code></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">reloadMasksFromVolume()</span></span>
<span class="line"><span style="color:#e1e4e8;">  │</span></span>
<span class="line"><span style="color:#e1e4e8;">  ├─ getOrCreateSliceBuffer(axis)          → get/create reusable ImageData buffer</span></span>
<span class="line"><span style="color:#e1e4e8;">  │   [RenderingUtils.ts]</span></span>
<span class="line"><span style="color:#e1e4e8;">  │</span></span>
<span class="line"><span style="color:#e1e4e8;">  ├─ FOR EACH layer:</span></span>
<span class="line"><span style="color:#e1e4e8;">  │   ├─ target.ctx.clearRect(...)         → clear layer canvas</span></span>
<span class="line"><span style="color:#e1e4e8;">  │   └─ renderSliceToCanvas(layerId, axis, sliceIndex, buffer, target.ctx, w, h)</span></span>
<span class="line"><span style="color:#e1e4e8;">  │       [RenderingUtils.ts]</span></span>
<span class="line"><span style="color:#e1e4e8;">  │       │</span></span>
<span class="line"><span style="color:#e1e4e8;">  │       ├─ volume.renderLabelSliceInto(...)  → render voxels into buffer</span></span>
<span class="line"><span style="color:#e1e4e8;">  │       ├─ emptyCtx.putImageData(buffer)     → put into emptyCanvas</span></span>
<span class="line"><span style="color:#e1e4e8;">  │       └─ targetCtx.drawImage(emptyCanvas)  → draw to layer canvas</span></span>
<span class="line"><span style="color:#e1e4e8;">  │           ⚠️ coronal view (axis=&#39;y&#39;) applies scale(1,-1) vertical flip (see §6.2)</span></span>
<span class="line"><span style="color:#e1e4e8;">  │</span></span>
<span class="line"><span style="color:#e1e4e8;">  └─ compositeAllLayers()                  → composite onto master canvas</span></span>
<span class="line"><span style="color:#e1e4e8;">      ├─ masterCtx.clearRect(...)</span></span>
<span class="line"><span style="color:#e1e4e8;">      └─ FOR EACH layer:</span></span>
<span class="line"><span style="color:#e1e4e8;">          ├─ if !layerVisibility[layerId] → skip</span></span>
<span class="line"><span style="color:#e1e4e8;">          └─ masterCtx.drawImage(layerCanvas)</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">reloadMasksFromVolume()</span></span>
<span class="line"><span style="color:#24292e;">  │</span></span>
<span class="line"><span style="color:#24292e;">  ├─ getOrCreateSliceBuffer(axis)          → get/create reusable ImageData buffer</span></span>
<span class="line"><span style="color:#24292e;">  │   [RenderingUtils.ts]</span></span>
<span class="line"><span style="color:#24292e;">  │</span></span>
<span class="line"><span style="color:#24292e;">  ├─ FOR EACH layer:</span></span>
<span class="line"><span style="color:#24292e;">  │   ├─ target.ctx.clearRect(...)         → clear layer canvas</span></span>
<span class="line"><span style="color:#24292e;">  │   └─ renderSliceToCanvas(layerId, axis, sliceIndex, buffer, target.ctx, w, h)</span></span>
<span class="line"><span style="color:#24292e;">  │       [RenderingUtils.ts]</span></span>
<span class="line"><span style="color:#24292e;">  │       │</span></span>
<span class="line"><span style="color:#24292e;">  │       ├─ volume.renderLabelSliceInto(...)  → render voxels into buffer</span></span>
<span class="line"><span style="color:#24292e;">  │       ├─ emptyCtx.putImageData(buffer)     → put into emptyCanvas</span></span>
<span class="line"><span style="color:#24292e;">  │       └─ targetCtx.drawImage(emptyCanvas)  → draw to layer canvas</span></span>
<span class="line"><span style="color:#24292e;">  │           ⚠️ coronal view (axis=&#39;y&#39;) applies scale(1,-1) vertical flip (see §6.2)</span></span>
<span class="line"><span style="color:#24292e;">  │</span></span>
<span class="line"><span style="color:#24292e;">  └─ compositeAllLayers()                  → composite onto master canvas</span></span>
<span class="line"><span style="color:#24292e;">      ├─ masterCtx.clearRect(...)</span></span>
<span class="line"><span style="color:#24292e;">      └─ FOR EACH layer:</span></span>
<span class="line"><span style="color:#24292e;">          ├─ if !layerVisibility[layerId] → skip</span></span>
<span class="line"><span style="color:#24292e;">          └─ masterCtx.drawImage(layerCanvas)</span></span></code></pre></div><hr><h2 id="_6-flip-mechanism" tabindex="-1">6. Flip Mechanism <a class="header-anchor" href="#_6-flip-mechanism" aria-label="Permalink to &quot;6. Flip Mechanism&quot;">​</a></h2><h3 id="_6-1-display-flip-ct-mri-image-only" tabindex="-1">6.1 Display Flip (CT/MRI image only) <a class="header-anchor" href="#_6-1-display-flip-ct-mri-image-only" aria-label="Permalink to &quot;6.1 Display Flip (CT/MRI image only)&quot;">​</a></h3><p><strong><code>flipDisplayImageByAxis()</code></strong> — <code>SliceRenderPipeline.flipDisplayImageByAxis()</code></p><p>Because the slices rendered by Three.js are not in the correct 2D orientation, the displayCanvas must be flipped:</p><table><thead><tr><th>Axis</th><th>Flip</th></tr></thead><tbody><tr><td>x (Sagittal)</td><td><code>scale(-1, -1)</code> + <code>translate(-w, -h)</code></td></tr><tr><td>y (Coronal)</td><td><code>scale(1, -1)</code> + <code>translate(0, -h)</code></td></tr><tr><td>z (Axial)</td><td><code>scale(1, -1)</code> + <code>translate(0, -h)</code></td></tr></tbody></table><p>Called from: <code>SliceRenderPipeline.redrawDisplayCanvas()</code></p><h3 id="_6-2-mask-flip-coronal-only" tabindex="-1">6.2 Mask Flip (Coronal only) <a class="header-anchor" href="#_6-2-mask-flip-coronal-only" aria-label="Permalink to &quot;6.2 Mask Flip (Coronal only)&quot;">​</a></h3><p><strong>Important</strong>: In <code>renderSliceToCanvas()</code> (RenderingUtils.ts), mask rendering <strong>applies a vertical flip for the coronal view (axis=&#39;y&#39;)</strong>:</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (axis </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;y&#39;</span><span style="color:#E1E4E8;">) {</span></span>
<span class="line"><span style="color:#E1E4E8;">  targetCtx.</span><span style="color:#B392F0;">save</span><span style="color:#E1E4E8;">();</span></span>
<span class="line"><span style="color:#E1E4E8;">  targetCtx.</span><span style="color:#B392F0;">scale</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">-</span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">);</span></span>
<span class="line"><span style="color:#E1E4E8;">  targetCtx.</span><span style="color:#B392F0;">translate</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#F97583;">-</span><span style="color:#E1E4E8;">scaledHeight);</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#E1E4E8;">targetCtx.</span><span style="color:#B392F0;">drawImage</span><span style="color:#E1E4E8;">(emptyCanvas, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">, scaledWidth, scaledHeight);</span></span>
<span class="line"><span style="color:#F97583;">if</span><span style="color:#E1E4E8;"> (axis </span><span style="color:#F97583;">===</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;y&#39;</span><span style="color:#E1E4E8;">) targetCtx.</span><span style="color:#B392F0;">restore</span><span style="color:#E1E4E8;">();</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (axis </span><span style="color:#D73A49;">===</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;y&#39;</span><span style="color:#24292E;">) {</span></span>
<span class="line"><span style="color:#24292E;">  targetCtx.</span><span style="color:#6F42C1;">save</span><span style="color:#24292E;">();</span></span>
<span class="line"><span style="color:#24292E;">  targetCtx.</span><span style="color:#6F42C1;">scale</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">-</span><span style="color:#005CC5;">1</span><span style="color:#24292E;">);</span></span>
<span class="line"><span style="color:#24292E;">  targetCtx.</span><span style="color:#6F42C1;">translate</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#D73A49;">-</span><span style="color:#24292E;">scaledHeight);</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#24292E;">targetCtx.</span><span style="color:#6F42C1;">drawImage</span><span style="color:#24292E;">(emptyCanvas, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">, scaledWidth, scaledHeight);</span></span>
<span class="line"><span style="color:#D73A49;">if</span><span style="color:#24292E;"> (axis </span><span style="color:#D73A49;">===</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;y&#39;</span><span style="color:#24292E;">) targetCtx.</span><span style="color:#6F42C1;">restore</span><span style="color:#24292E;">();</span></span></code></pre></div><table><thead><tr><th>Axis</th><th>Mask Flip</th><th>Notes</th></tr></thead><tbody><tr><td>z (Axial)</td><td><strong>None</strong></td><td>Storage coordinates match Three.js slice</td></tr><tr><td>y (Coronal)</td><td><strong>Vertical flip</strong> <code>scale(1,-1)</code></td><td>Cancels out the flip in the write path, ensuring cross-axis display consistency</td></tr><tr><td>x (Sagittal)</td><td><strong>None</strong></td><td>Storage coordinates match Three.js slice</td></tr></tbody></table><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>Previous documentation stating &quot;mask has no flip&quot; is outdated. A Y-axis flip was introduced for the coronal view to fix a cross-axis slice alignment bug.</p></div><h3 id="_6-3-applymaskflipforaxis-helper-method" tabindex="-1">6.3 applyMaskFlipForAxis (helper method) <a class="header-anchor" href="#_6-3-applymaskflipforaxis-helper-method" aria-label="Permalink to &quot;6.3 applyMaskFlipForAxis (helper method)&quot;">​</a></h3><p><code>RenderingUtils.applyMaskFlipForAxis()</code> — provides the same flip transform as <code>flipDisplayImageByAxis()</code>, available for scenarios requiring manual coordinate alignment.</p><hr><h2 id="_7-tools" tabindex="-1">7. Tools <a class="header-anchor" href="#_7-tools" aria-label="Permalink to &quot;7. Tools&quot;">​</a></h2><p>Location: <code>src/Utils/segmentation/tools/</code></p><p>All Tools / modules extend <code>BaseTool</code> (<code>tools/BaseTool.ts</code>):</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ToolContext</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">nrrd_states</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">NrrdState</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">gui_states</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">GuiState</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">protectedData</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IProtected</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">cursorPage</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ICursorPage</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">callbacks</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IAnnotationCallbacks</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span>
<span class="line"><span style="color:#F97583;">abstract</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">class</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">BaseTool</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">constructor</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">ctx</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ToolContext</span><span style="color:#E1E4E8;">)</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">setContext</span><span style="color:#E1E4E8;">(</span><span style="color:#FFAB70;">ctx</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">ToolContext</span><span style="color:#E1E4E8;">)</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">void</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ToolContext</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">nrrd_states</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">NrrdState</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">gui_states</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">GuiState</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">protectedData</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IProtected</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">cursorPage</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ICursorPage</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">callbacks</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IAnnotationCallbacks</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span>
<span class="line"><span style="color:#D73A49;">abstract</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">class</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">BaseTool</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">constructor</span><span style="color:#24292E;">(</span><span style="color:#E36209;">ctx</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ToolContext</span><span style="color:#24292E;">)</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">setContext</span><span style="color:#24292E;">(</span><span style="color:#E36209;">ctx</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">ToolContext</span><span style="color:#24292E;">)</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">void</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><h3 id="_7-1-tool-list" tabindex="-1">7.1 Tool List <a class="header-anchor" href="#_7-1-tool-list" aria-label="Permalink to &quot;7.1 Tool List&quot;">​</a></h3><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><strong>ToolHost unified interface (complete)</strong>: All Tool host method dependencies have been unified into the <code>ToolHost</code> interface in <code>tools/ToolHost.ts</code>. Each Tool selects its required method subset via <code>Pick&lt;ToolHost, ...&gt;</code>. The original 10 independent <code>*Callbacks</code> interfaces have been removed.</p></div><h4 id="nrrdtools-extracted-modules-god-class-split" tabindex="-1">NrrdTools Extracted Modules (God Class Split) <a class="header-anchor" href="#nrrdtools-extracted-modules-god-class-split" aria-label="Permalink to &quot;NrrdTools Extracted Modules (God Class Split)&quot;">​</a></h4><table><thead><tr><th>Module</th><th>File</th><th>Lines</th><th>HostDeps Type</th></tr></thead><tbody><tr><td><strong>LayerChannelManager</strong></td><td><code>tools/LayerChannelManager.ts</code></td><td>211</td><td><code>LayerChannelHostDeps</code> (3 methods)</td></tr><tr><td><strong>SliceRenderPipeline</strong></td><td><code>tools/SliceRenderPipeline.ts</code></td><td>453</td><td><code>SliceRenderHostDeps</code> (10 methods)</td></tr><tr><td><strong>DataLoader</strong></td><td><code>tools/DataLoader.ts</code></td><td>222</td><td><code>DataLoaderHostDeps</code> (7 methods)</td></tr></tbody></table><h4 id="drawtoolcore-managed-tools-event-handling" tabindex="-1">DrawToolCore-Managed Tools (event handling) <a class="header-anchor" href="#drawtoolcore-managed-tools-event-handling" aria-label="Permalink to &quot;DrawToolCore-Managed Tools (event handling)&quot;">​</a></h4><table><thead><tr><th>Tool</th><th>File</th><th>Description</th></tr></thead><tbody><tr><td><strong>SphereTool</strong></td><td><code>tools/SphereTool.ts</code></td><td>3D sphere annotation; 4 types (tumour/skin/ribcage/nipple); click-to-place + release-to-confirm</td></tr><tr><td><strong>CrosshairTool</strong></td><td><code>tools/CrosshairTool.ts</code></td><td>Crosshair position marker, coordinate conversion, crosshair rendering</td></tr><tr><td><strong>ContrastTool</strong></td><td><code>tools/ContrastTool.ts</code></td><td>Window/Level (brightness/contrast) adjustment</td></tr><tr><td><strong>ZoomTool</strong></td><td><code>tools/ZoomTool.ts</code></td><td>Zoom and pan</td></tr><tr><td><strong>EraserTool</strong></td><td><code>tools/EraserTool.ts</code></td><td>Eraser</td></tr><tr><td><strong>PanTool</strong></td><td><code>tools/PanTool.ts</code></td><td>Right-click drag to pan the canvas</td></tr><tr><td><strong>DrawingTool</strong></td><td><code>tools/DrawingTool.ts</code></td><td>Pencil/brush/eraser drawing; brush hover tracking; circle preview</td></tr><tr><td><strong>ImageStoreHelper</strong></td><td><code>tools/ImageStoreHelper.ts</code></td><td>Canvas ↔ Volume sync</td></tr><tr><td><strong>DragSliceTool</strong></td><td><code>tools/DragSliceTool.ts</code></td><td>Drag to scroll through slices</td></tr></tbody></table><p>Tool initialization: <code>DrawToolCore.ts</code> → <code>initTools()</code></p><h3 id="_7-2-imagestorehelper-key-tool" tabindex="-1">7.2 ImageStoreHelper (key tool) <a class="header-anchor" href="#_7-2-imagestorehelper-key-tool" aria-label="Permalink to &quot;7.2 ImageStoreHelper (key tool)&quot;">​</a></h3><p><strong><code>storeAllImages(index, layer)</code></strong> — Canvas → Volume sync flow:</p><ol><li>Draw the layer canvas onto emptyCanvas</li><li>Read ImageData from emptyCanvas</li><li>Call <code>volume.setSliceLabelsFromImageData()</code> to write to MaskVolume</li><li>Extract the slice and notify the backend</li></ol><p><strong><code>filterDrawedImage(axis, sliceIndex)</code></strong> — Volume → Canvas read: calls <code>volume.renderLabelSliceInto()</code>.</p><h3 id="_7-3-spheretool" tabindex="-1">7.3 SphereTool <a class="header-anchor" href="#_7-3-spheretool" aria-label="Permalink to &quot;7.3 SphereTool&quot;">​</a></h3><p><strong>File</strong>: <code>tools/SphereTool.ts</code></p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">SphereType</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;tumour&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;skin&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;nipple&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;ribcage&#39;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SPHERE_CHANNEL_MAP</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Record</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">SphereType</span><span style="color:#E1E4E8;">, { </span><span style="color:#FFAB70;">layer</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string</span><span style="color:#E1E4E8;">; </span><span style="color:#FFAB70;">channel</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;"> }&gt;;</span></span>
<span class="line"><span style="color:#6A737D;">// SPHERE_COLORS removed — colors derived dynamically from each volume&#39;s colorMap</span></span>
<span class="line"><span style="color:#F97583;">const</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">SPHERE_LABELS</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Record</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">SphereType</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;default&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">&gt;;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">SphereType</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;tumour&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;skin&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;nipple&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;ribcage&#39;</span><span style="color:#24292E;">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SPHERE_CHANNEL_MAP</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Record</span><span style="color:#24292E;">&lt;</span><span style="color:#6F42C1;">SphereType</span><span style="color:#24292E;">, { </span><span style="color:#E36209;">layer</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string</span><span style="color:#24292E;">; </span><span style="color:#E36209;">channel</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;"> }&gt;;</span></span>
<span class="line"><span style="color:#6A737D;">// SPHERE_COLORS removed — colors derived dynamically from each volume&#39;s colorMap</span></span>
<span class="line"><span style="color:#D73A49;">const</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">SPHERE_LABELS</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Record</span><span style="color:#24292E;">&lt;</span><span style="color:#6F42C1;">SphereType</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;default&#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">&gt;;</span></span></code></pre></div><p><strong>Interaction Methods:</strong></p><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td><code>onSphereClick(e)</code></td><td>Left-click: record origin, store typed origin, enable crosshair, draw preview</td></tr><tr><td><code>onSpherePointerUp()</code></td><td>Left-click release: write all spheres to volume, refresh overlay, fire callbacks</td></tr></tbody></table><p><strong>SphereHostDeps:</strong></p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">SphereHostDeps</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Pick</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">ToolHost</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;setEmptyCanvasSize&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;drawImageOnEmptyImage&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;enableCrosshair&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;setUpSphereOrigins&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">&gt;;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">SphereHostDeps</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Pick</span><span style="color:#24292E;">&lt;</span><span style="color:#6F42C1;">ToolHost</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;setEmptyCanvasSize&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;drawImageOnEmptyImage&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;enableCrosshair&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;setUpSphereOrigins&#39;</span></span>
<span class="line"><span style="color:#24292E;">&gt;;</span></span></code></pre></div><p><strong>Interaction constraints when sphere mode is active:</strong></p><ul><li>❌ Shift key disabled (cannot enter draw mode)</li><li>✅ Crosshair toggle available (S key)</li><li>❌ Contrast mode blocked</li></ul><p><strong>Interaction flow:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">Left mouse down → record origin for activeSphereType → activeWheelMode = &#39;sphere&#39; → draw preview</span></span>
<span class="line"><span style="color:#e1e4e8;">Scroll wheel (while held) → sphereRadius ±1 [1, 50] → redraw</span></span>
<span class="line"><span style="color:#e1e4e8;">Left mouse up → write all spheres to volume → fire getSphere + getCalculateSpherePositions → activeWheelMode = &#39;zoom&#39;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">Left mouse down → record origin for activeSphereType → activeWheelMode = &#39;sphere&#39; → draw preview</span></span>
<span class="line"><span style="color:#24292e;">Scroll wheel (while held) → sphereRadius ±1 [1, 50] → redraw</span></span>
<span class="line"><span style="color:#24292e;">Left mouse up → write all spheres to volume → fire getSphere + getCalculateSpherePositions → activeWheelMode = &#39;zoom&#39;</span></span></code></pre></div><p><strong>SphereMaskVolume:</strong> An independent <code>MaskVolume</code> (<code>nrrd_states.sphereMaskVolume</code>) stores sphere 3D data without polluting layer draw masks. Created in <code>setAllSlices()</code>, cleared in <code>reset()</code>.</p><h3 id="_7-4-pantool" tabindex="-1">7.4 PanTool <a class="header-anchor" href="#_7-4-pantool" aria-label="Permalink to &quot;7.4 PanTool&quot;">​</a></h3><p><strong>File</strong>: <code>tools/PanTool.ts</code> — 124 lines. Handles all right-click drag pan logic.</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p><code>getPanelOffset</code> / <code>setPanelOffset</code> callbacks no longer exist. PanTool reads offsets directly via <code>canvas.offsetLeft</code> / <code>canvas.offsetTop</code>.</p></div><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">PanHostDeps</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Pick</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">ToolHost</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39;zoomActionAfterDrawSphere&#39;</span><span style="color:#E1E4E8;">&gt;;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">PanHostDeps</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Pick</span><span style="color:#24292E;">&lt;</span><span style="color:#6F42C1;">ToolHost</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39;zoomActionAfterDrawSphere&#39;</span><span style="color:#24292E;">&gt;;</span></span></code></pre></div><h3 id="_7-5-drawingtool" tabindex="-1">7.5 DrawingTool <a class="header-anchor" href="#_7-5-drawingtool" aria-label="Permalink to &quot;7.5 DrawingTool&quot;">​</a></h3><p><strong>File</strong>: <code>tools/DrawingTool.ts</code> — 284 lines. Handles pencil, brush, and eraser drawing logic including Undo snapshots.</p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">type</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">DrawingHostDeps</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Pick</span><span style="color:#E1E4E8;">&lt;</span><span style="color:#B392F0;">ToolHost</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#9ECBFF;">&#39;setCurrentLayer&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;compositeAllLayers&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;syncLayerSliceData&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;filterDrawedImage&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;getVolumeForLayer&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;pushUndoDelta&#39;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;getEraserUrls&#39;</span></span>
<span class="line"><span style="color:#E1E4E8;">&gt;;</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">type</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">DrawingHostDeps</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Pick</span><span style="color:#24292E;">&lt;</span><span style="color:#6F42C1;">ToolHost</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#032F62;">&#39;setCurrentLayer&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;compositeAllLayers&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;syncLayerSliceData&#39;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;filterDrawedImage&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;getVolumeForLayer&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;pushUndoDelta&#39;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;getEraserUrls&#39;</span></span>
<span class="line"><span style="color:#24292E;">&gt;;</span></span></code></pre></div><p><strong><code>onPointerLeave()</code> return value</strong>: Returns <code>true</code> if the user was drawing when leaving the canvas, signaling DrawToolCore to restore <code>activeWheelMode = &#39;zoom&#39;</code>.</p><p><strong>Undo snapshot mechanism:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">mousedown → capturePreDrawSnapshot()</span></span>
<span class="line"><span style="color:#e1e4e8;">  → volume.getSliceUint8(sliceIndex, axis)  ← before operation</span></span>
<span class="line"><span style="color:#e1e4e8;">  → saved to preDrawSlice / preDrawAxis / preDrawSliceIndex</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">mouseup → pushUndoDelta()</span></span>
<span class="line"><span style="color:#e1e4e8;">  → volume.getSliceUint8(sliceIndex, axis)  ← after operation</span></span>
<span class="line"><span style="color:#e1e4e8;">  → pushUndoDelta({ layerId, axis, sliceIndex, oldSlice: preDrawSlice, newSlice })</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">mousedown → capturePreDrawSnapshot()</span></span>
<span class="line"><span style="color:#24292e;">  → volume.getSliceUint8(sliceIndex, axis)  ← before operation</span></span>
<span class="line"><span style="color:#24292e;">  → saved to preDrawSlice / preDrawAxis / preDrawSliceIndex</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">mouseup → pushUndoDelta()</span></span>
<span class="line"><span style="color:#24292e;">  → volume.getSliceUint8(sliceIndex, axis)  ← after operation</span></span>
<span class="line"><span style="color:#24292e;">  → pushUndoDelta({ layerId, axis, sliceIndex, oldSlice: preDrawSlice, newSlice })</span></span></code></pre></div><hr><h2 id="_8-eventrouter" tabindex="-1">8. EventRouter <a class="header-anchor" href="#_8-eventrouter" aria-label="Permalink to &quot;8. EventRouter&quot;">​</a></h2><p><strong>File</strong>: <code>eventRouter/EventRouter.ts</code></p><h3 id="_8-1-interaction-modes" tabindex="-1">8.1 Interaction Modes <a class="header-anchor" href="#_8-1-interaction-modes" aria-label="Permalink to &quot;8.1 Interaction Modes&quot;">​</a></h3><table><thead><tr><th>Mode</th><th>Trigger</th><th>Description</th></tr></thead><tbody><tr><td><code>idle</code></td><td>Default</td><td>No interaction</td></tr><tr><td><code>draw</code></td><td>Shift held</td><td>Drawing mode</td></tr><tr><td><code>drag</code></td><td>Vertical drag</td><td>Slice navigation</td></tr><tr><td><code>contrast</code></td><td>Ctrl/Meta held</td><td>Window/Level adjustment</td></tr><tr><td><code>crosshair</code></td><td>S key</td><td>Crosshair mode</td></tr></tbody></table><h3 id="_8-2-permanent-event-routing" tabindex="-1">8.2 Permanent Event Routing <a class="header-anchor" href="#_8-2-permanent-event-routing" aria-label="Permalink to &quot;8.2 Permanent Event Routing&quot;">​</a></h3><p>EventRouter permanently binds all pointer/keyboard/wheel events to the drawingCanvas in <code>bindAll()</code>. DrawToolCore registers handlers via <code>set*Handler()</code> — no more manual <code>addEventListener</code>/<code>removeEventListener</code>.</p><table><thead><tr><th>Handler</th><th>Guard Condition</th></tr></thead><tbody><tr><td><code>setPointerDownHandler</code></td><td>None</td></tr><tr><td><code>setPointerMoveHandler</code></td><td><code>drawingTool.isActive || panTool.isActive</code></td></tr><tr><td><code>setPointerUpHandler</code></td><td><code>drawingTool.isActive || drawingTool.painting || panTool.isActive || sphere mode</code></td></tr><tr><td><code>setPointerLeaveHandler</code></td><td>None</td></tr><tr><td><code>setWheelHandler</code></td><td>Dispatches based on <code>activeWheelMode</code></td></tr></tbody></table><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p><strong>Guard conditions are essential</strong>: Without them, idle mouse movement would prevent the Brush preview and Crosshair from rendering (DrawingTool.onPointerMove unconditionally sets <code>isDrawing=true</code>).</p></div><h3 id="_8-3-wheel-dispatcher-activewheelmode" tabindex="-1">8.3 Wheel Dispatcher (<code>activeWheelMode</code>) <a class="header-anchor" href="#_8-3-wheel-dispatcher-activewheelmode" aria-label="Permalink to &quot;8.3 Wheel Dispatcher (`activeWheelMode`)&quot;">​</a></h3><table><thead><tr><th>Mode</th><th>Trigger</th><th>Dispatch Target</th></tr></thead><tbody><tr><td><code>&#39;zoom&#39;</code></td><td>Default / restored after mouseUp</td><td><code>handleMouseZoomSliceWheel</code></td></tr><tr><td><code>&#39;sphere&#39;</code></td><td>Set by <code>handleSphereClick</code></td><td><code>handleSphereWheel</code></td></tr><tr><td><code>&#39;none&#39;</code></td><td>Set by mouseDown in draw mode</td><td>No-op (wheel suppressed)</td></tr></tbody></table><h3 id="_8-4-default-keyboard-settings" tabindex="-1">8.4 Default Keyboard Settings <a class="header-anchor" href="#_8-4-default-keyboard-settings" aria-label="Permalink to &quot;8.4 Default Keyboard Settings&quot;">​</a></h3><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#E1E4E8;">IKeyBoardSettings </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  draw: </span><span style="color:#9ECBFF;">&quot;Shift&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  undo: </span><span style="color:#9ECBFF;">&quot;z&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  redo: </span><span style="color:#9ECBFF;">&quot;y&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  contrast: [</span><span style="color:#9ECBFF;">&quot;Control&quot;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&quot;Meta&quot;</span><span style="color:#E1E4E8;">],</span></span>
<span class="line"><span style="color:#E1E4E8;">  crosshair: </span><span style="color:#9ECBFF;">&quot;s&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  sphere: </span><span style="color:#9ECBFF;">&quot;q&quot;</span><span style="color:#E1E4E8;">,</span></span>
<span class="line"><span style="color:#E1E4E8;">  mouseWheel: </span><span style="color:#9ECBFF;">&quot;Scroll:Zoom&quot;</span><span style="color:#E1E4E8;">,   </span><span style="color:#6A737D;">// or &quot;Scroll:Slice&quot;</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292E;">IKeyBoardSettings </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  draw: </span><span style="color:#032F62;">&quot;Shift&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  undo: </span><span style="color:#032F62;">&quot;z&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  redo: </span><span style="color:#032F62;">&quot;y&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  contrast: [</span><span style="color:#032F62;">&quot;Control&quot;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&quot;Meta&quot;</span><span style="color:#24292E;">],</span></span>
<span class="line"><span style="color:#24292E;">  crosshair: </span><span style="color:#032F62;">&quot;s&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  sphere: </span><span style="color:#032F62;">&quot;q&quot;</span><span style="color:#24292E;">,</span></span>
<span class="line"><span style="color:#24292E;">  mouseWheel: </span><span style="color:#032F62;">&quot;Scroll:Zoom&quot;</span><span style="color:#24292E;">,   </span><span style="color:#6A737D;">// or &quot;Scroll:Slice&quot;</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><hr><h2 id="_9-undo-redo-system" tabindex="-1">9. Undo/Redo System <a class="header-anchor" href="#_9-undo-redo-system" aria-label="Permalink to &quot;9. Undo/Redo System&quot;">​</a></h2><p><strong>File</strong>: <code>core/UndoManager.ts</code></p><div class="language-ts vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">ts</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">interface</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">MaskDelta</span><span style="color:#E1E4E8;"> {</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">layerId</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">string</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">axis</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;x&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;y&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">|</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;z&quot;</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">sliceIndex</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">number</span><span style="color:#E1E4E8;">;</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">oldSlice</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Uint8Array</span><span style="color:#E1E4E8;">;   </span><span style="color:#6A737D;">// Slice data before the operation</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#FFAB70;">newSlice</span><span style="color:#F97583;">:</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">Uint8Array</span><span style="color:#E1E4E8;">;   </span><span style="color:#6A737D;">// Slice data after the operation</span></span>
<span class="line"><span style="color:#E1E4E8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">interface</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">MaskDelta</span><span style="color:#24292E;"> {</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">layerId</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">string</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">axis</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;x&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;y&quot;</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">|</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;z&quot;</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">sliceIndex</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">number</span><span style="color:#24292E;">;</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">oldSlice</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Uint8Array</span><span style="color:#24292E;">;   </span><span style="color:#6A737D;">// Slice data before the operation</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#E36209;">newSlice</span><span style="color:#D73A49;">:</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">Uint8Array</span><span style="color:#24292E;">;   </span><span style="color:#6A737D;">// Slice data after the operation</span></span>
<span class="line"><span style="color:#24292E;">}</span></span></code></pre></div><ul><li>Independent undo/redo stack per layer</li><li><code>MAX_STACK_SIZE = 50</code></li></ul><p><strong>Undo flow:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">DrawToolCore.undoLastPainting()</span></span>
<span class="line"><span style="color:#e1e4e8;">  → UndoManager.undo() → MaskDelta</span></span>
<span class="line"><span style="color:#e1e4e8;">  → vol.setSliceUint8(delta.sliceIndex, delta.oldSlice, delta.axis)</span></span>
<span class="line"><span style="color:#e1e4e8;">  → applyUndoRedoToCanvas(layerId)</span></span>
<span class="line"><span style="color:#e1e4e8;">    → getOrCreateSliceBuffer(axis)</span></span>
<span class="line"><span style="color:#e1e4e8;">    → renderSliceToCanvas(...)</span></span>
<span class="line"><span style="color:#e1e4e8;">    → compositeAllLayers()</span></span>
<span class="line"><span style="color:#e1e4e8;">  → annotationCallbacks.onMaskChanged(...) → notify backend</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">DrawToolCore.undoLastPainting()</span></span>
<span class="line"><span style="color:#24292e;">  → UndoManager.undo() → MaskDelta</span></span>
<span class="line"><span style="color:#24292e;">  → vol.setSliceUint8(delta.sliceIndex, delta.oldSlice, delta.axis)</span></span>
<span class="line"><span style="color:#24292e;">  → applyUndoRedoToCanvas(layerId)</span></span>
<span class="line"><span style="color:#24292e;">    → getOrCreateSliceBuffer(axis)</span></span>
<span class="line"><span style="color:#24292e;">    → renderSliceToCanvas(...)</span></span>
<span class="line"><span style="color:#24292e;">    → compositeAllLayers()</span></span>
<span class="line"><span style="color:#24292e;">  → annotationCallbacks.onMaskChanged(...) → notify backend</span></span></code></pre></div><hr><h2 id="_10-dragoperator" tabindex="-1">10. DragOperator <a class="header-anchor" href="#_10-dragoperator" aria-label="Permalink to &quot;10. DragOperator&quot;">​</a></h2><p><strong>File</strong>: <code>DragOperator.ts</code> — Responsible for drag-based slice navigation.</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p><strong>Event Lifecycle Refactor change</strong>: DragOperator no longer manually manages wheel event listeners. Wheel events are now entirely managed by EventRouter&#39;s <code>activeWheelMode</code> dispatcher.</p></div><table><thead><tr><th>Method</th><th>Description</th></tr></thead><tbody><tr><td><code>drag(opts?)</code></td><td>Enable drag mode</td></tr><tr><td><code>configDragMode()</code></td><td>Bind drag event listeners</td></tr><tr><td><code>removeDragMode()</code></td><td>Remove drag event listeners</td></tr><tr><td><code>updateIndex(move)</code></td><td>Delegates to DragSliceTool</td></tr><tr><td><code>setEventRouter(eventRouter)</code></td><td>Subscribe to mode changes</td></tr></tbody></table><hr><h2 id="_11-channel-color-definitions" tabindex="-1">11. Channel Color Definitions <a class="header-anchor" href="#_11-channel-color-definitions" aria-label="Permalink to &quot;11. Channel Color Definitions&quot;">​</a></h2><p><strong>File</strong>: <code>core/types.ts</code></p><h3 id="_11-1-default-colors-global-constants" tabindex="-1">11.1 Default Colors (global constants) <a class="header-anchor" href="#_11-1-default-colors-global-constants" aria-label="Permalink to &quot;11.1 Default Colors (global constants)&quot;">​</a></h3><table><thead><tr><th>Channel</th><th>Color</th><th>Hex</th><th>RGBA</th></tr></thead><tbody><tr><td>0</td><td>Transparent</td><td><code>#000000</code></td><td><code>(0,0,0,0)</code></td></tr><tr><td>1</td><td>Emerald (Tumour)</td><td><code>#10b981</code></td><td><code>(16,185,129,255)</code></td></tr><tr><td>2</td><td>Rose (Edema)</td><td><code>#f43f5e</code></td><td><code>(244,63,94,255)</code></td></tr><tr><td>3</td><td>Blue (Necrosis)</td><td><code>#3b82f6</code></td><td><code>(59,130,246,255)</code></td></tr><tr><td>4</td><td>Amber (Enhancement)</td><td><code>#fbbf24</code></td><td><code>(251,191,36,255)</code></td></tr><tr><td>5</td><td>Fuchsia (Vessel)</td><td><code>#d946ef</code></td><td><code>(217,70,239,255)</code></td></tr><tr><td>6</td><td>Cyan (Additional)</td><td><code>#06b6d4</code></td><td><code>(6,182,212,255)</code></td></tr><tr><td>7</td><td>Orange (Auxiliary)</td><td><code>#f97316</code></td><td><code>(249,115,22,255)</code></td></tr><tr><td>8</td><td>Violet (Extended)</td><td><code>#8b5cf6</code></td><td><code>(139,92,246,255)</code></td></tr></tbody></table><p>Exported as: <code>MASK_CHANNEL_COLORS</code> (RGBA), <code>MASK_CHANNEL_CSS_COLORS</code> (CSS), <code>CHANNEL_HEX_COLORS</code> (Hex)</p><h3 id="_11-2-color-conversion-utilities" tabindex="-1">11.2 Color Conversion Utilities <a class="header-anchor" href="#_11-2-color-conversion-utilities" aria-label="Permalink to &quot;11.2 Color Conversion Utilities&quot;">​</a></h3><table><thead><tr><th>Function</th><th>Signature</th><th>Description</th></tr></thead><tbody><tr><td><code>rgbaToHex</code></td><td><code>(color: RGBAColor) → string</code></td><td>Convert to Hex, e.g. <code>#ff8000</code></td></tr><tr><td><code>rgbaToCss</code></td><td><code>(color: RGBAColor) → string</code></td><td>Convert to CSS rgba(), e.g. <code>rgba(255,128,0,1.00)</code></td></tr></tbody></table><h3 id="_11-3-per-layer-custom-colors" tabindex="-1">11.3 Per-Layer Custom Colors <a class="header-anchor" href="#_11-3-per-layer-custom-colors" aria-label="Permalink to &quot;11.3 Per-Layer Custom Colors&quot;">​</a></h3><p>Each <code>MaskVolume</code> instance owns an independent <code>colorMap: ChannelColorMap</code>, deep-copied from <code>MASK_CHANNEL_COLORS</code> at construction. Modifying a layer&#39;s color does not affect other layers.</p><p><strong>Color flow path:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">volume.colorMap[channel]</span></span>
<span class="line"><span style="color:#e1e4e8;">  ↓ renderLabelSliceInto()     → canvas rendering reads colorMap</span></span>
<span class="line"><span style="color:#e1e4e8;">  ↓ buildRgbToChannelMap()     → canvas → volume write-back reads colorMap</span></span>
<span class="line"><span style="color:#e1e4e8;">  ↓ EraserTool.getChannelColor → eraser color matching reads colorMap</span></span>
<span class="line"><span style="color:#e1e4e8;">  ↓ syncBrushColor()           → brush color reads colorMap</span></span>
<span class="line"><span style="color:#e1e4e8;">  ↓ getChannelCssColor()       → Vue UI reads colorMap for display</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">volume.colorMap[channel]</span></span>
<span class="line"><span style="color:#24292e;">  ↓ renderLabelSliceInto()     → canvas rendering reads colorMap</span></span>
<span class="line"><span style="color:#24292e;">  ↓ buildRgbToChannelMap()     → canvas → volume write-back reads colorMap</span></span>
<span class="line"><span style="color:#24292e;">  ↓ EraserTool.getChannelColor → eraser color matching reads colorMap</span></span>
<span class="line"><span style="color:#24292e;">  ↓ syncBrushColor()           → brush color reads colorMap</span></span>
<span class="line"><span style="color:#24292e;">  ↓ getChannelCssColor()       → Vue UI reads colorMap for display</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-a3c25e27 data-v-a2d931e4><!--[--><!--]--><!----><nav class="prev-next" data-v-a2d931e4><div class="pager" data-v-a2d931e4><a class="pager-link prev" href="/copper3d_visualisation/guide/nrrd-tools.html" data-v-a2d931e4><span class="desc" data-v-a2d931e4>Previous page</span><span class="title" data-v-a2d931e4>NrrdTools Usage Guide</span></a></div><div class="pager" data-v-a2d931e4><!----></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"apidist_modules_renderer_copperrendererondemond.md\":\"3a655fb9\",\"apidist_modules_renderer_copperrenderer.md\":\"21951b1a\",\"apidist_classes_utils_meshnodetool.node.md\":\"ee2f4278\",\"apidist_classes_renderer_coppermscenerenderer.coppermscenerenderer.md\":\"92dd07bd\",\"apidist_modules.md\":\"b1acf424\",\"apidist_modules_controls_copper3dtrackballcontrols.md\":\"0dc9210f\",\"apidist_modules_controls_coppercontrols.md\":\"90df69a1\",\"apidist_modules_renderer_coppermscenerenderer.md\":\"49827154\",\"apidist_modules_loader_coppernrrdloader.md\":\"bd9bb014\",\"apidist_modules_renderer_baserenderer.md\":\"b28c03bf\",\"apidist_classes_renderer_baserenderer.baserenderer.md\":\"4dca97ca\",\"apidist_modules_scene_commonscenemethod.md\":\"03a638f1\",\"apidist_modules_scene_coppermscene.md\":\"9050160c\",\"apidist_classes_scene_coppersceneondemond.coppersceneondemond.md\":\"565b6740\",\"apidist_classes_utils_meshnodetool.meshnodetool.md\":\"c034977f\",\"apidist_modules_scene_copperscene.md\":\"1a21b247\",\"apidist_modules_scene_basescene.md\":\"6842adae\",\"apidist_classes_utils_segmentation_coretools_nrrdstate.nrrdstate.md\":\"d1d01512\",\"apidist_classes_utils_segmentation_coretools_guistate.guistate.md\":\"b8d71e12\",\"apidist_modules_utils_segmentation_coretools_nrrdstate.md\":\"3f4a241f\",\"apidist_modules_utils_segmentation_coretools_guistate.md\":\"e627dc34\",\"apidist_modules_utils_segmentation_core_maskvolume.md\":\"13ae327e\",\"apidist_modules_utils_segmentation_tools_spheretool.md\":\"b0f122ff\",\"apidist_classes_controls_coppercontrols.cameraviewpoint.md\":\"6ef90dd7\",\"apidist_classes_scene_commonscenemethod.commonscene.md\":\"f8d2f3fb\",\"apidist_classes_utils_segmentation_nrrdtools.nrrdtools.md\":\"1947694a\",\"apidist_classes_utils_meshnodetool.element.md\":\"f4e18906\",\"apidist_classes_renderer_copperrenderer.copperrenderer.md\":\"af855d65\",\"apidist_classes_controls_coppercontrols.controls.md\":\"68a88463\",\"apidist_classes_controls_copper3dtrackballcontrols.copper3dtrackballcontrols.md\":\"9c913557\",\"apidist_classes_utils_segmentation_core_maskvolume.maskvolume.md\":\"55ee029e\",\"guide_nrrd-tools.md\":\"83dea979\",\"zh_guide_nrrd-tools.md\":\"891d5d96\",\"apidist_classes_scene_basescene.basescene.md\":\"69f59bfa\",\"apidist_classes_renderer_copperrendererondemond.copperrendererondemond.md\":\"ea93a0ac\",\"apidist_modules_utils_segmentation_nrrdtools.md\":\"98dc8640\",\"apidist_modules_scene_coppersceneondemond.md\":\"67889485\",\"apidist_readme.md\":\"b33a013c\",\"apidist_modules_utils_meshnodetool.md\":\"b50ec67d\",\"apidist_classes_scene_copperscene.copperscene.md\":\"797f5d69\",\"zh_index.md\":\"be283230\",\"apidist_interfaces_loader_coppernrrdloader.optstype.md\":\"6de1b990\",\"guide_segmentation-module.md\":\"16e1da9b\",\"apidist_modules_utils_utils.md\":\"9d9a2223\",\"index.md\":\"2672c1a4\",\"apidist_classes_utils_segmentation_tools_spheretool.spheretool.md\":\"192102c0\",\"apidist_classes_scene_coppermscene.coppermscene.md\":\"2ba7fbad\",\"zh_guide_segmentation-module.md\":\"ee813f0d\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Copper3d API\",\"description\":\"A VitePress site\",\"base\":\"/copper3d_visualisation/\",\"head\":[],\"appearance\":true,\"themeConfig\":{\"repo\":\"LinkunGao/copper3d_visualisation\",\"nav\":[{\"text\":\"Guide\",\"link\":\"/guide/nrrd-tools\"},{\"text\":\"API\",\"link\":\"/apidist/modules\"}],\"sidebar\":{\"/guide/\":[{\"text\":\"Usage Guide\",\"items\":[{\"text\":\"NrrdTools Usage Guide\",\"link\":\"/guide/nrrd-tools\"}]},{\"text\":\"Architecture\",\"items\":[{\"text\":\"Segmentation Module\",\"link\":\"/guide/segmentation-module\"}]}],\"/apidist/\":[{\"text\":\"Controls/Copper3dTrackballControls\",\"items\":[{\"text\":\"Controls/Copper3dTrackballControls\",\"link\":\"/apidist/modules/Controls_Copper3dTrackballControls\"},{\"text\":\"Class:Copper3dTrackballControls\",\"link\":\"/apidist/classes/Controls_Copper3dTrackballControls.Copper3dTrackballControls\"}]},{\"text\":\"Controls/copperControls\",\"items\":[{\"text\":\"Controls/copperControls\",\"link\":\"/apidist/modules/Controls_copperControls\"},{\"text\":\"Class:CameraViewPoint\",\"link\":\"/apidist/classes/Controls_copperControls.CameraViewPoint\"},{\"text\":\"Class:Controls\",\"link\":\"/apidist/classes/Controls_copperControls.Controls\"}]},{\"text\":\"Loader/copperNrrdLoader\",\"items\":[{\"text\":\"Loader/copperNrrdLoader\",\"link\":\"/apidist/modules/Loader_copperNrrdLoader\"},{\"text\":\"Interface:optsType\",\"link\":\"/apidist/interfaces/Loader_copperNrrdLoader.optsType\"},{\"text\":\"Function:addBoxHelper\",\"link\":\"/apidist/functions/Loader_copperNrrdLoader.addBoxHelper\"},{\"text\":\"Function:copperNrrdLoader\",\"link\":\"/apidist/functions/Loader_copperNrrdLoader.copperNrrdLoader\"},{\"text\":\"Function:copperNrrdTexture3dLoader\",\"link\":\"/apidist/functions/Loader_copperNrrdLoader.copperNrrdTexture3dLoader\"},{\"text\":\"Function:getWholeSlices\",\"link\":\"/apidist/functions/Loader_copperNrrdLoader.getWholeSlices\"}]},{\"text\":\"Renderer/baseRenderer\",\"items\":[{\"text\":\"Renderer/baseRenderer\",\"link\":\"/apidist/modules/Renderer_baseRenderer\"},{\"text\":\"Class:baseRenderer\",\"link\":\"/apidist/classes/Renderer_baseRenderer.baseRenderer\"}]},{\"text\":\"Renderer/copperMSceneRenderer\",\"items\":[{\"text\":\"Renderer/copperMSceneRenderer\",\"link\":\"/apidist/modules/Renderer_copperMSceneRenderer\"},{\"text\":\"Class:copperMSceneRenderer\",\"link\":\"/apidist/classes/Renderer_copperMSceneRenderer.copperMSceneRenderer\"}]},{\"text\":\"Renderer/copperRenderer\",\"items\":[{\"text\":\"Renderer/copperRenderer\",\"link\":\"/apidist/modules/Renderer_copperRenderer\"},{\"text\":\"Class:copperRenderer\",\"link\":\"/apidist/classes/Renderer_copperRenderer.copperRenderer\"}]},{\"text\":\"Renderer/copperRendererOnDemond\",\"items\":[{\"text\":\"Renderer/copperRendererOnDemond\",\"link\":\"/apidist/modules/Renderer_copperRendererOnDemond\"},{\"text\":\"Class:copperRendererOnDemond\",\"link\":\"/apidist/classes/Renderer_copperRendererOnDemond.copperRendererOnDemond\"}]},{\"text\":\"Scene/baseScene\",\"items\":[{\"text\":\"Scene/baseScene\",\"link\":\"/apidist/modules/Scene_baseScene\"},{\"text\":\"Class:baseScene\",\"link\":\"/apidist/classes/Scene_baseScene.baseScene\"}]},{\"text\":\"Scene/commonSceneMethod\",\"items\":[{\"text\":\"Scene/commonSceneMethod\",\"link\":\"/apidist/modules/Scene_commonSceneMethod\"},{\"text\":\"Class:commonScene\",\"link\":\"/apidist/classes/Scene_commonSceneMethod.commonScene\"}]},{\"text\":\"Scene/copperMScene\",\"items\":[{\"text\":\"Scene/copperMScene\",\"link\":\"/apidist/modules/Scene_copperMScene\"},{\"text\":\"Class:copperMScene\",\"link\":\"/apidist/classes/Scene_copperMScene.copperMScene\"}]},{\"text\":\"Scene/copperScene\",\"items\":[{\"text\":\"Scene/copperScene\",\"link\":\"/apidist/modules/Scene_copperScene\"},{\"text\":\"Class:copperScene\",\"link\":\"/apidist/classes/Scene_copperScene.copperScene\"}]},{\"text\":\"Scene/copperSceneOnDemond\",\"items\":[{\"text\":\"Scene/copperSceneOnDemond\",\"link\":\"/apidist/modules/Scene_copperSceneOnDemond\"},{\"text\":\"Class:copperSceneOnDemond\",\"link\":\"/apidist/classes/Scene_copperSceneOnDemond.copperSceneOnDemond\"}]},{\"text\":\"Utils/MeshNodeTool\",\"items\":[{\"text\":\"Utils/MeshNodeTool\",\"link\":\"/apidist/modules/Utils_MeshNodeTool\"},{\"text\":\"Class:Element\",\"link\":\"/apidist/classes/Utils_MeshNodeTool.Element\"},{\"text\":\"Class:MeshNodeTool\",\"link\":\"/apidist/classes/Utils_MeshNodeTool.MeshNodeTool\"},{\"text\":\"Class:Node\",\"link\":\"/apidist/classes/Utils_MeshNodeTool.Node\"}]},{\"text\":\"Utils/segmentation/NrrdTools\",\"items\":[{\"text\":\"Utils/segmentation/NrrdTools\",\"link\":\"/apidist/modules/Utils_segmentation_NrrdTools\"},{\"text\":\"Class:NrrdTools\",\"link\":\"/apidist/classes/Utils_segmentation_NrrdTools.NrrdTools\"}]},{\"text\":\"Utils/segmentation/core/MaskVolume\",\"items\":[{\"text\":\"Utils/segmentation/core/MaskVolume\",\"link\":\"/apidist/modules/Utils_segmentation_core_MaskVolume\"},{\"text\":\"Class:MaskVolume\",\"link\":\"/apidist/classes/Utils_segmentation_core_MaskVolume.MaskVolume\"}]},{\"text\":\"Utils/segmentation/coreTools/GuiState\",\"items\":[{\"text\":\"Utils/segmentation/coreTools/GuiState\",\"link\":\"/apidist/modules/Utils_segmentation_coreTools_GuiState\"},{\"text\":\"Class:GuiState\",\"link\":\"/apidist/classes/Utils_segmentation_coreTools_GuiState.GuiState\"}]},{\"text\":\"Utils/segmentation/coreTools/NrrdState\",\"items\":[{\"text\":\"Utils/segmentation/coreTools/NrrdState\",\"link\":\"/apidist/modules/Utils_segmentation_coreTools_NrrdState\"},{\"text\":\"Class:NrrdState\",\"link\":\"/apidist/classes/Utils_segmentation_coreTools_NrrdState.NrrdState\"}]},{\"text\":\"Utils/segmentation/tools/SphereTool\",\"items\":[{\"text\":\"Utils/segmentation/tools/SphereTool\",\"link\":\"/apidist/modules/Utils_segmentation_tools_SphereTool\"},{\"text\":\"Class:SphereTool\",\"link\":\"/apidist/classes/Utils_segmentation_tools_SphereTool.SphereTool\"}]},{\"text\":\"Utils/utils\",\"items\":[{\"text\":\"Utils/utils\",\"link\":\"/apidist/modules/Utils_utils\"},{\"text\":\"Function:H3\",\"link\":\"/apidist/functions/Utils_utils.H3\"},{\"text\":\"Function:L3\",\"link\":\"/apidist/functions/Utils_utils.L3\"},{\"text\":\"Function:calcDistance\",\"link\":\"/apidist/functions/Utils_utils.calcDistance\"},{\"text\":\"Function:fullScreenListenner\",\"link\":\"/apidist/functions/Utils_utils.fullScreenListenner\"},{\"text\":\"Function:getWightsH3H3H3\",\"link\":\"/apidist/functions/Utils_utils.getWightsH3H3H3\"},{\"text\":\"Function:getWightsL3L3L3\",\"link\":\"/apidist/functions/Utils_utils.getWightsL3L3L3\"},{\"text\":\"Function:isIOS\",\"link\":\"/apidist/functions/Utils_utils.isIOS\"},{\"text\":\"Function:loading\",\"link\":\"/apidist/functions/Utils_utils.loading\"},{\"text\":\"Function:perturbRandom\",\"link\":\"/apidist/functions/Utils_utils.perturbRandom\"},{\"text\":\"Function:switchEraserSize\",\"link\":\"/apidist/functions/Utils_utils.switchEraserSize\"},{\"text\":\"Function:switchPencilIcon\",\"link\":\"/apidist/functions/Utils_utils.switchPencilIcon\"},{\"text\":\"Function:throttle\",\"link\":\"/apidist/functions/Utils_utils.throttle\"},{\"text\":\"Function:traverseMaterials\",\"link\":\"/apidist/functions/Utils_utils.traverseMaterials\"}]}]},\"search\":{\"provider\":\"algolia\",\"options\":{\"appId\":\"T4ABFE0UY4\",\"apiKey\":\"10d8841459f0b508e1394464b203cb63\",\"indexName\":\"copper3d-visualisation\",\"locales\":{\"zh\":{\"placeholder\":\"搜索文档\",\"translations\":{\"button\":{\"buttonText\":\"搜索文档\",\"buttonAriaLabel\":\"搜索文档\"},\"modal\":{\"searchBox\":{\"resetButtonTitle\":\"清除查询条件\",\"resetButtonAriaLabel\":\"清除查询条件\",\"cancelButtonText\":\"取消\",\"cancelButtonAriaLabel\":\"取消\"},\"startScreen\":{\"recentSearchesTitle\":\"搜索历史\",\"noRecentSearchesText\":\"没有搜索历史\",\"saveRecentSearchButtonTitle\":\"保存至搜索历史\",\"removeRecentSearchButtonTitle\":\"从搜索历史中移除\",\"favoriteSearchesTitle\":\"收藏\",\"removeFavoriteSearchButtonTitle\":\"从收藏中移除\"},\"errorScreen\":{\"titleText\":\"无法获取结果\",\"helpText\":\"你可能需要检查你的网络连接\"},\"footer\":{\"selectText\":\"选择\",\"navigateText\":\"切换\",\"closeText\":\"关闭\",\"searchByText\":\"搜索提供者\"},\"noResultsScreen\":{\"noResultsText\":\"无法找到相关结果\",\"suggestedQueryText\":\"你可以尝试查询\",\"reportMissingResultsText\":\"你认为该查询应该有结果？\",\"reportMissingResultsLinkText\":\"点击反馈\"}}}}}}}},\"locales\":{\"root\":{\"label\":\"English\",\"lang\":\"en\"},\"zh\":{\"label\":\"简体中文\",\"lang\":\"zh\",\"link\":\"/zh/\",\"themeConfig\":{\"nav\":[{\"text\":\"指南\",\"link\":\"/zh/guide/nrrd-tools\"},{\"text\":\"API\",\"link\":\"/apidist/modules\"}],\"sidebar\":{\"/zh/guide/\":[{\"text\":\"使用指南\",\"items\":[{\"text\":\"NrrdTools 使用指南\",\"link\":\"/zh/guide/nrrd-tools\"}]},{\"text\":\"架构\",\"items\":[{\"text\":\"分割模块\",\"link\":\"/zh/guide/segmentation-module\"}]}],\"/apidist/\":[{\"text\":\"Controls/Copper3dTrackballControls\",\"items\":[{\"text\":\"Controls/Copper3dTrackballControls\",\"link\":\"/apidist/modules/Controls_Copper3dTrackballControls\"},{\"text\":\"Class:Copper3dTrackballControls\",\"link\":\"/apidist/classes/Controls_Copper3dTrackballControls.Copper3dTrackballControls\"}]},{\"text\":\"Controls/copperControls\",\"items\":[{\"text\":\"Controls/copperControls\",\"link\":\"/apidist/modules/Controls_copperControls\"},{\"text\":\"Class:CameraViewPoint\",\"link\":\"/apidist/classes/Controls_copperControls.CameraViewPoint\"},{\"text\":\"Class:Controls\",\"link\":\"/apidist/classes/Controls_copperControls.Controls\"}]},{\"text\":\"Loader/copperNrrdLoader\",\"items\":[{\"text\":\"Loader/copperNrrdLoader\",\"link\":\"/apidist/modules/Loader_copperNrrdLoader\"},{\"text\":\"Interface:optsType\",\"link\":\"/apidist/interfaces/Loader_copperNrrdLoader.optsType\"},{\"text\":\"Function:addBoxHelper\",\"link\":\"/apidist/functions/Loader_copperNrrdLoader.addBoxHelper\"},{\"text\":\"Function:copperNrrdLoader\",\"link\":\"/apidist/functions/Loader_copperNrrdLoader.copperNrrdLoader\"},{\"text\":\"Function:copperNrrdTexture3dLoader\",\"link\":\"/apidist/functions/Loader_copperNrrdLoader.copperNrrdTexture3dLoader\"},{\"text\":\"Function:getWholeSlices\",\"link\":\"/apidist/functions/Loader_copperNrrdLoader.getWholeSlices\"}]},{\"text\":\"Renderer/baseRenderer\",\"items\":[{\"text\":\"Renderer/baseRenderer\",\"link\":\"/apidist/modules/Renderer_baseRenderer\"},{\"text\":\"Class:baseRenderer\",\"link\":\"/apidist/classes/Renderer_baseRenderer.baseRenderer\"}]},{\"text\":\"Renderer/copperMSceneRenderer\",\"items\":[{\"text\":\"Renderer/copperMSceneRenderer\",\"link\":\"/apidist/modules/Renderer_copperMSceneRenderer\"},{\"text\":\"Class:copperMSceneRenderer\",\"link\":\"/apidist/classes/Renderer_copperMSceneRenderer.copperMSceneRenderer\"}]},{\"text\":\"Renderer/copperRenderer\",\"items\":[{\"text\":\"Renderer/copperRenderer\",\"link\":\"/apidist/modules/Renderer_copperRenderer\"},{\"text\":\"Class:copperRenderer\",\"link\":\"/apidist/classes/Renderer_copperRenderer.copperRenderer\"}]},{\"text\":\"Renderer/copperRendererOnDemond\",\"items\":[{\"text\":\"Renderer/copperRendererOnDemond\",\"link\":\"/apidist/modules/Renderer_copperRendererOnDemond\"},{\"text\":\"Class:copperRendererOnDemond\",\"link\":\"/apidist/classes/Renderer_copperRendererOnDemond.copperRendererOnDemond\"}]},{\"text\":\"Scene/baseScene\",\"items\":[{\"text\":\"Scene/baseScene\",\"link\":\"/apidist/modules/Scene_baseScene\"},{\"text\":\"Class:baseScene\",\"link\":\"/apidist/classes/Scene_baseScene.baseScene\"}]},{\"text\":\"Scene/commonSceneMethod\",\"items\":[{\"text\":\"Scene/commonSceneMethod\",\"link\":\"/apidist/modules/Scene_commonSceneMethod\"},{\"text\":\"Class:commonScene\",\"link\":\"/apidist/classes/Scene_commonSceneMethod.commonScene\"}]},{\"text\":\"Scene/copperMScene\",\"items\":[{\"text\":\"Scene/copperMScene\",\"link\":\"/apidist/modules/Scene_copperMScene\"},{\"text\":\"Class:copperMScene\",\"link\":\"/apidist/classes/Scene_copperMScene.copperMScene\"}]},{\"text\":\"Scene/copperScene\",\"items\":[{\"text\":\"Scene/copperScene\",\"link\":\"/apidist/modules/Scene_copperScene\"},{\"text\":\"Class:copperScene\",\"link\":\"/apidist/classes/Scene_copperScene.copperScene\"}]},{\"text\":\"Scene/copperSceneOnDemond\",\"items\":[{\"text\":\"Scene/copperSceneOnDemond\",\"link\":\"/apidist/modules/Scene_copperSceneOnDemond\"},{\"text\":\"Class:copperSceneOnDemond\",\"link\":\"/apidist/classes/Scene_copperSceneOnDemond.copperSceneOnDemond\"}]},{\"text\":\"Utils/MeshNodeTool\",\"items\":[{\"text\":\"Utils/MeshNodeTool\",\"link\":\"/apidist/modules/Utils_MeshNodeTool\"},{\"text\":\"Class:Element\",\"link\":\"/apidist/classes/Utils_MeshNodeTool.Element\"},{\"text\":\"Class:MeshNodeTool\",\"link\":\"/apidist/classes/Utils_MeshNodeTool.MeshNodeTool\"},{\"text\":\"Class:Node\",\"link\":\"/apidist/classes/Utils_MeshNodeTool.Node\"}]},{\"text\":\"Utils/segmentation/NrrdTools\",\"items\":[{\"text\":\"Utils/segmentation/NrrdTools\",\"link\":\"/apidist/modules/Utils_segmentation_NrrdTools\"},{\"text\":\"Class:NrrdTools\",\"link\":\"/apidist/classes/Utils_segmentation_NrrdTools.NrrdTools\"}]},{\"text\":\"Utils/segmentation/core/MaskVolume\",\"items\":[{\"text\":\"Utils/segmentation/core/MaskVolume\",\"link\":\"/apidist/modules/Utils_segmentation_core_MaskVolume\"},{\"text\":\"Class:MaskVolume\",\"link\":\"/apidist/classes/Utils_segmentation_core_MaskVolume.MaskVolume\"}]},{\"text\":\"Utils/segmentation/coreTools/GuiState\",\"items\":[{\"text\":\"Utils/segmentation/coreTools/GuiState\",\"link\":\"/apidist/modules/Utils_segmentation_coreTools_GuiState\"},{\"text\":\"Class:GuiState\",\"link\":\"/apidist/classes/Utils_segmentation_coreTools_GuiState.GuiState\"}]},{\"text\":\"Utils/segmentation/coreTools/NrrdState\",\"items\":[{\"text\":\"Utils/segmentation/coreTools/NrrdState\",\"link\":\"/apidist/modules/Utils_segmentation_coreTools_NrrdState\"},{\"text\":\"Class:NrrdState\",\"link\":\"/apidist/classes/Utils_segmentation_coreTools_NrrdState.NrrdState\"}]},{\"text\":\"Utils/segmentation/tools/SphereTool\",\"items\":[{\"text\":\"Utils/segmentation/tools/SphereTool\",\"link\":\"/apidist/modules/Utils_segmentation_tools_SphereTool\"},{\"text\":\"Class:SphereTool\",\"link\":\"/apidist/classes/Utils_segmentation_tools_SphereTool.SphereTool\"}]},{\"text\":\"Utils/utils\",\"items\":[{\"text\":\"Utils/utils\",\"link\":\"/apidist/modules/Utils_utils\"},{\"text\":\"Function:H3\",\"link\":\"/apidist/functions/Utils_utils.H3\"},{\"text\":\"Function:L3\",\"link\":\"/apidist/functions/Utils_utils.L3\"},{\"text\":\"Function:calcDistance\",\"link\":\"/apidist/functions/Utils_utils.calcDistance\"},{\"text\":\"Function:fullScreenListenner\",\"link\":\"/apidist/functions/Utils_utils.fullScreenListenner\"},{\"text\":\"Function:getWightsH3H3H3\",\"link\":\"/apidist/functions/Utils_utils.getWightsH3H3H3\"},{\"text\":\"Function:getWightsL3L3L3\",\"link\":\"/apidist/functions/Utils_utils.getWightsL3L3L3\"},{\"text\":\"Function:isIOS\",\"link\":\"/apidist/functions/Utils_utils.isIOS\"},{\"text\":\"Function:loading\",\"link\":\"/apidist/functions/Utils_utils.loading\"},{\"text\":\"Function:perturbRandom\",\"link\":\"/apidist/functions/Utils_utils.perturbRandom\"},{\"text\":\"Function:switchEraserSize\",\"link\":\"/apidist/functions/Utils_utils.switchEraserSize\"},{\"text\":\"Function:switchPencilIcon\",\"link\":\"/apidist/functions/Utils_utils.switchPencilIcon\"},{\"text\":\"Function:throttle\",\"link\":\"/apidist/functions/Utils_utils.throttle\"},{\"text\":\"Function:traverseMaterials\",\"link\":\"/apidist/functions/Utils_utils.traverseMaterials\"}]}]}}}},\"scrollOffset\":90,\"cleanUrls\":false}");</script>
    
  </body>
</html>